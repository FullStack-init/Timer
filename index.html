<!DOCTYPE html>
<html lang="es" class="h-full bg-base-200 text-base-content">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fitness Timer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.7.0/dist/full.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script>
        tailwind.config = {
            darkMode: "class",
            plugins: [require("daisyui")],
            daisyui: {
                themes: ["luxury", "cyberpunk", "forest", "lofi", "corporate", "light", "abyss", "synthwave", "black", "dark"],
                darkTheme: "luxury"
            }
        };
    </script>
    <style>
        :root {
            /* Variables de dise√±o consistentes */
            --led-on: #00fffc;
            --led-off: rgba(0, 100, 100, 0.1);
            --glow-intensity: 10px;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --animation-fast: 150ms;
            --animation-medium: 300ms;
            --animation-slow: 500ms;
        }
        
        .light-theme {
            --led-on: #00a8a8;
            --led-off: rgba(0, 0, 0, 0.05);
        }
        
        .segment {
            position: absolute;
            background: var(--led-off);
            border-radius: 3px;
            transition: all 0.1s;
        }
        
        .segment.on {
            background: var(--led-on);
            box-shadow: 0 0 var(--glow-intensity) var(--led-on);
        }
        
        .glow-effect .segment.on {
            box-shadow: 0 0 15px 5px var(--led-on);
        }
        
        .segment-a { width: 40px; height: 8px; top: 0; left: 10px; }
        .segment-b { width: 8px; height: 40px; top: 8px; right: 0; }
        .segment-c { width: 8px; height: 40px; bottom: 8px; right: 0; }
        .segment-d { width: 40px; height: 8px; bottom: 0; left: 10px; }
        .segment-e { width: 8px; height: 40px; bottom: 8px; left: 0; }
        .segment-f { width: 8px; height: 40px; top: 8px; left: 0; }
        .segment-g { width: 40px; height: 8px; top: 50%; left: 10px; transform: translateY(-50%); }
        
        .colon {
            width: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            height: 100%;
        }
        
        .colon-dot {
            width: 8px;
            height: 8px;
            background: var(--led-on);
            border-radius: 50%;
            margin: 15px 0;
            opacity: 0.7;
        }
        
        @keyframes edit-mode-indicator {
            0% { opacity: 0.3; }
            50% { opacity: 0.6; }
            100% { opacity: 0.3; }
        }
        
        .edit-mode-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: edit-mode-indicator 2s infinite;
        }
        
        .edit-mode .program-btn {
            box-shadow: 0 0 0 2px #3b82f6 inset;
            transition: all var(--animation-medium) ease;
        }
        
        .edit-mode .program-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 0 2px #3b82f6 inset, 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .concentration-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .concentration-display {
            transform: scale(1.5);
            margin-bottom: 1.5rem;
        }
        
        .progress-info {
            font-size: 2rem;
            color: var(--led-on);
            text-align: center;
            margin-bottom: 1.5rem;
            min-height: 2.5rem;
        }
        
        .concentration-controls {
            opacity: 0.3;
            transition: opacity var(--animation-medium);
        }
        
        .concentration-controls:hover {
            opacity: 1;
        }
        
        .display-container {
            background: rgba(15, 15, 25, 0.9);
            border-radius: var(--radius-lg);
            padding: 15px 25px;
            box-shadow: 
                0 0 25px rgba(0, 0, 0, 0.6),
                inset 0 0 10px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(80, 80, 100, 0.3);
            aspect-ratio: 16/6;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all var(--animation-medium) ease;
        }
        
        .display-container:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.6),
                inset 0 0 10px rgba(0, 0, 0, 0.4);
        }
        
        .digits {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: relative;
            padding: 5px 0;
        }
        
        .digit-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            padding: 0 5px;
        }
        
        .digit {
            position: relative;
            width: 60px; 
            height: 100px;
            margin: 0 3px;
            flex-shrink: 0;
        }
        
        .fullscreen-btn {
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            background: rgba(0, 150, 150, 0.3);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--led-on);
            cursor: pointer;
            opacity: 0.3;
            transition: all var(--animation-medium);
            z-index: 10;
        }
        
        .fullscreen-btn:hover {
            opacity: 1;
            background: rgba(0, 150, 150, 0.5);
            transform: scale(1.1);
        }
        
        .custom-program-card {
            position: relative;
        }
        
        .delete-custom {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff0000;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--animation-fast);
            z-index: 10;
        }
        
        .delete-custom:hover {
            transform: scale(1.2);
            background: #ff3333;
        }
        
        .edit-mode .custom-program-card .delete-custom {
            display: flex;
        }
        
        .program-btn.active {
            background: #3b82f6 !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transition: all var(--animation-medium) ease;
        }
        
        .program-btn.running {
            animation: pulse 1.5s infinite;
        }
        
        .program-info {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        
        /* Control buttons */
        .control-buttons {
            display: flex;
            gap: var(--space-md);
            width: 100%;
        }
        
        .control-button {
            flex: 1;
            height: 3.5rem;
            border-radius: var(--radius-md);
            transition: all var(--animation-medium) ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Edit mode indicator */
        .edit-mode .edit-corner {
            background-color: #3b82f6 !important;
        }
        
        .edit-mode .edit-corner i {
            animation: edit-mode-indicator 2s infinite;
        }
        
        /* Responsive improvements for mobile */
        @media (max-width: 768px) {
            .display-container {
                padding: 10px 15px;
                border-radius: var(--radius-md);
            }
            
            .digit {
                width: 45px;
                height: 75px;
            }
            
            .segment-a { width: 30px; height: 6px; left: 7px; }
            .segment-b { width: 6px; height: 30px; top: 6px; }
            .segment-c { width: 6px; height: 30px; bottom: 6px; }
            .segment-d { width: 30px; height: 6px; left: 7px; }
            .segment-e { width: 6px; height: 30px; bottom: 6px; }
            .segment-f { width: 6px; height: 30px; top: 6px; }
            .segment-g { width: 30px; height: 6px; left: 7px; }
            
            .colon {
                width: 12px;
            }
            
            .colon-dot {
                width: 6px;
                height: 6px;
                margin: 12px 0;
            }
            
            .fullscreen-btn {
                width: 25px;
                height: 25px;
            }
            
            .control-button {
                height: 3rem;
                font-size: 0.875rem;
            }
        }
        
        @media (max-width: 480px) {
            .display-container {
                padding: 8px 12px;
                border-radius: var(--radius-sm);
            }
            
            .digit {
                width: 35px;
                height: 55px;
            }
            
            .segment-a { width: 22px; height: 4px; left: 5px; }
            .segment-b { width: 4px; height: 22px; top: 4px; }
            .segment-c { width: 4px; height: 22px; bottom: 4px; }
            .segment-d { width: 22px; height: 4px; left: 5px; }
            .segment-e { width: 4px; height: 22px; bottom: 4px; }
            .segment-f { width: 4px; height: 22px; top: 4px; }
            .segment-g { width: 22px; height: 4px; left: 5px; }
            
            .colon {
                width: 10px;
            }
            
            .colon-dot {
                width: 4px;
                height: 4px;
                margin: 8px 0;
            }
            
            .fullscreen-btn {
                width: 20px;
                height: 20px;
            }
            
            .concentration-display {
                transform: scale(1.2);
            }
            
            .control-button {
                height: 2.5rem;
                font-size: 0.75rem;
            }
        }
        
        /* Countdown overlay */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        
        .countdown-number {
            font-size: 10rem;
            color: var(--led-on);
            text-shadow: 0 0 15px var(--led-on);
            font-weight: bold;
        }
        
        .countdown-text {
            font-size: 2rem;
            color: white;
            margin-top: 1rem;
        }
        
        /* Correcci√≥n del bot√≥n minimizar en modo concentraci√≥n */
        .minimize-btn-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
        }
    </style>
</head>
<body class="h-full flex flex-col glow-effect">
    <!-- Navbar -->
    <nav class="navbar bg-base-300 px-4 py-3 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div class="app-name text-xl font-bold text-primary flex items-center gap-2">
            <i class="fas fa-dumbbell"></i>
            FITNESS TIMER PRO
        </div>
        <div class="nav-actions flex items-center gap-3">
            <button id="global-config-btn" class="btn btn-ghost btn-circle" title="Configuraci√≥n global">
                <i class="fas fa-cog"></i>
            </button>
            <div class="wifi-status badge badge-outline badge-primary gap-2">
                <i class="fas fa-wifi"></i>
                <span>Conectado</span>
            </div>
        </div>
    </nav>
    <!-- Contenido principal -->
    <main class="container mx-auto p-4 max-w-lg flex-1 flex flex-col">
        <!-- Display principal optimizado -->
        <div class="display-container relative">
            <button class="fullscreen-btn" id="fullscreen-btn">
                <i class="fas fa-expand"></i>
            </button>
            <div class="digits" id="display"></div>
        </div>
        <!-- Botones de acci√≥n principal -->
        <div class="control-buttons mt-4">
            <button id="action-btn" class="btn btn-primary btn-lg control-button" aria-label="Iniciar temporizador" aria-pressed="false">Iniciar</button>
            <button id="reset-btn" class="btn btn-secondary btn-lg control-button" aria-label="Reiniciar temporizador">Reset</button>
        </div>
        <!-- Programas de entrenamiento -->
        <div class="programs-section bg-base-100 rounded-2xl p-4 shadow-lg border border-base-300 relative mt-4">
            <div class="edit-corner absolute top-0 right-0 w-10 h-10 flex items-center justify-center bg-primary text-primary-content rounded-bl-2xl cursor-pointer" id="edit-corner">
                <i class="fas fa-pencil-alt"></i>
            </div>
            <div class="section-header mb-4">
                <h2 class="section-title text-lg font-semibold text-center">
                    Programas de Entrenamiento
                </h2>
            </div>
            <div class="programs grid grid-cols-3 gap-3" id="programs-container">
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="clock">
                    <div class="btn-text">Reloj</div>
                    <div class="program-info">Hora actual</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="stopwatch">
                    <div class="btn-text">Cron√≥metro</div>
                    <div class="program-info">Cuenta ascendente</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="count-up">
                    <div class="btn-text">Contador Asc.</div>
                    <div class="program-info">Hasta l√≠mite</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="count-down">
                    <div class="btn-text">Contador Desc.</div>
                    <div class="program-info">Desde inicial</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="amrap">
                    <div class="btn-text">AMRAP</div>
                    <div class="program-info">Tantas rondas</div>
                </div>
                <!-- For Time ahora est√° inmediatamente despu√©s de AMRAP -->
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="for-time">
                    <div class="btn-text">For Time</div>
                    <div class="program-info">Tiempo m√°ximo</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="tabata">
                    <div class="btn-text">TABATA</div>
                    <div class="program-info">20s trabajo/10s desc</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="emom">
                    <div class="btn-text">EMOM</div>
                    <div class="program-info">Cada minuto</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="hiit">
                    <div class="btn-text">HIIT</div>
                    <div class="program-info">Entrenamiento intenso</div>
                </div>
                <div class="program-btn custom hidden aspect-square bg-base-200 border-2 border-dashed border-primary rounded-xl p-3 text-center cursor-pointer transition-all" data-program="custom">
                    <div class="custom-program-text text-primary font-semibold text-sm">
                        <i class="fas fa-plus-circle"></i>
                        Crear programa
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-300 text-base-content">
        <aside>
            <p>Conectado a dispositivo f√≠sico ‚Ä¢ Versi√≥n 2.5</p>
        </aside>
    </footer>
    <!-- Modales -->
    <!-- Modal de configuraci√≥n global -->
    <dialog id="config-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configuraci√≥n Global</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tema de color</span>
                    </label>
                    <select id="themeSwitcher" class="select select-bordered">
                        <option value="luxury">Luxury</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="forest">Forest</option>
                        <option value="lofi">Lofi</option>
                        <option value="corporate">Corporate</option>
                        <option value="light">Light</option>
                        <option value="abyss">Abyss</option>
                        <option value="synthwave">Synthwave</option>
                        <option value="black">Black</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Sonidos</span> 
                        <input type="checkbox" id="sound-toggle" class="toggle toggle-primary" checked />
                    </label>
                </div>
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Efecto retroiluminaci√≥n</span> 
                        <input type="checkbox" id="glow-effect-toggle" class="toggle toggle-primary" checked />
                    </label>
                </div>
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Maximizaci√≥n autom√°tica</span> 
                        <input type="checkbox" id="auto-fullscreen-toggle" class="toggle toggle-primary" checked />
                    </label>
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Cuenta regresiva por defecto</span>
                    </label>
                    <select id="default-countdown" class="select select-bordered">
                        <option value="0">0 segundos</option>
                        <option value="3">3 segundos</option>
                        <option value="5">5 segundos</option>
                        <option value="10">10 segundos</option>
                        <option value="15">15 segundos</option>
                        <option value="20">20 segundos</option>
                        <option value="30">30 segundos</option>
                        <option value="45">45 segundos</option>
                        <option value="60">60 segundos</option>
                    </select>
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Intensidad de LEDs</span>
                    </label>
                    <input type="range" min="1" max="10" value="8" class="range range-primary" id="led-intensity" />
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Importar/Exportar programas</span>
                    </label>
                    <div class="flex gap-2">
                        <button id="export-programs-btn" class="btn btn-outline btn-sm w-full">
                            <i class="fas fa-download mr-1"></i> Exportar
                        </button>
                        <button id="import-programs-btn" class="btn btn-outline btn-sm w-full">
                            <i class="fas fa-upload mr-1"></i> Importar
                        </button>
                    </div>
                    <input type="file" id="import-file-input" accept=".json" class="hidden" />
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-ghost">Cancelar</button>
                    <button class="btn btn-primary" id="save-config">Guardar</button>
                </form>
            </div>
        </div>
    </dialog>
    <!-- Modal de creaci√≥n/edici√≥n de programas -->
    <dialog id="create-program-modal" class="modal">
        <div class="modal-box max-w-md w-full">
            <form method="dialog" id="programForm">
                <header class="flex justify-between items-center pb-2">
                    <h3 class="font-bold text-lg" id="modal-title">Crear programa</h3>
                    <button type="button" class="btn btn-circle btn-ghost btn-sm" id="closeDialogBtn">
                        √ó
                    </button>
                </header>
                <div class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <input
                            type="text"
                            id="program-name"
                            placeholder="Nombre del programa"
                            required
                            class="input input-bordered input-sm w-full text-sm"
                        />
                        <select
                            id="countdown"
                            class="select select-bordered select-sm w-full text-sm"
                        >
                            <option value="0">Sin cuenta regresiva</option>
                            <option value="3">3 segundos</option>
                            <option value="5">5 segundos</option>
                            <option value="10">10 segundos</option>
                            <option value="15">15 segundos</option>
                            <option value="20">20 segundos</option>
                            <option value="30">30 segundos</option>
                        </select>
                    </div>
                    <textarea
                        id="program-description"
                        placeholder="Descripci√≥n del programa (opcional)"
                        class="textarea textarea-bordered textarea-sm w-full text-sm"
                    ></textarea>
                </div>
                <div class="mt-3">
                    <h4 class="mb-2 font-semibold text-sm">Bloques de tiempo:</h4>
                    <div
                        id="blockList"
                        class="block-list-container border border-dashed border-transparent"
                    ></div>
                </div>
                <div class="mt-3 flex gap-2 justify-center">
                    <button
                        type="button"
                        id="addMainBlockBtn"
                        class="btn btn-outline btn-sm w-full"
                    >
                        + A√±adir Bloque
                    </button>
                </div>
                <div class="modal-action mt-3">
                    <button
                        type="button"
                        id="cancelCreate"
                        class="btn btn-ghost btn-sm"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm" id="saveProgramBtn">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </dialog>
    <!-- Modales de configuraci√≥n de programas -->
    <!-- Modal Contador Ascendente -->
    <dialog id="config-count-up-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Contador Ascendente</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tiempo m√°ximo (mm:ss)</span>
                    </label>
                    <input type="text" id="count-up-max" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¬øQu√© es el Contador Ascendente?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">El contador ascendente comienza en 00:00 y cuenta hacia arriba hasta el tiempo m√°ximo que configures. Es √∫til para medir cu√°nto tiempo llevas en una actividad.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-count-up">Cancelar</button>
                <button class="btn btn-primary" id="apply-count-up">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal Contador Descendente -->
    <dialog id="config-count-down-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Contador Descendente</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tiempo inicial (mm:ss)</span>
                    </label>
                    <input type="text" id="count-down-init" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¬øQu√© es el Contador Descendente?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">Comienza en el tiempo configurado y cuenta hacia abajo hasta 00:00. Ideal para ejercicios con tiempo l√≠mite.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-count-down">Cancelar</button>
                <button class="btn btn-primary" id="apply-count-down">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal AMRAP -->
    <dialog id="config-amrap-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar AMRAP</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Duraci√≥n (mm:ss)</span>
                    </label>
                    <input type="text" id="amrap-duration" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¬øQu√© es AMRAP?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">AMRAP (As Many Rounds As Possible): Completa tantas rondas como sea posible de un circuito en el tiempo establecido. El tiempo corre en cuenta regresiva.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-amrap">Cancelar</button>
                <button class="btn btn-primary" id="apply-amrap">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal FOR TIME -->
    <dialog id="config-for-time-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar For Time</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tiempo m√°ximo (mm:ss)</span>
                    </label>
                    <input type="text" id="for-time-max" class="input input-bordered" placeholder="00:00" value="10:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¬øQu√© es For Time?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">For Time: Completa un circuito espec√≠fico en el menor tiempo posible. El tiempo m√°ximo establece el l√≠mite para completar el circuito.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-for-time">Cancelar</button>
                <button class="btn btn-primary" id="apply-for-time">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal EMOM -->
    <dialog id="config-emom-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar EMOM</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Duraci√≥n total (minutos)</span>
                    </label>
                    <input type="number" id="emom-total" class="input input-bordered" min="1" max="60" value="10">
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Repeticiones por minuto</span>
                    </label>
                    <input type="number" id="emom-reps" class="input input-bordered" min="1" max="20" value="10">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¬øQu√© es EMOM?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">EMOM (Every Minute On the Minute): Realiza los ejercicios al inicio de cada minuto. El tiempo restante del minuto es para descanso. El contador es descendente.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-emom">Cancelar</button>
                <button class="btn btn-primary" id="apply-emom">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal HIIT -->
    <dialog id="config-hiit-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar HIIT</h3>
            <div class="py-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Calentamiento</span>
                        </label>
                        <select id="hiit-warmup" class="select select-bordered">
                            <option value="0">0 min</option>
                            <option value="3">3 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="7">7 min</option>
                            <option value="10">10 min</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trabajo intenso</span>
                        </label>
                        <select id="hiit-work" class="select select-bordered">
                            <option value="20" selected>20 s</option>
                            <option value="30">30 s</option>
                            <option value="40">40 s</option>
                            <option value="45">45 s</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Descanso</span>
                        </label>
                        <select id="hiit-rest" class="select select-bordered">
                            <option value="10" selected>10 s</option>
                            <option value="15">15 s</option>
                            <option value="20">20 s</option>
                            <option value="30">30 s</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Repeticiones</span>
                        </label>
                        <select id="hiit-rounds" class="select select-bordered">
                            <option value="4">4</option>
                            <option value="6">6</option>
                            <option value="8" selected>8</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Enfriamiento</span>
                        </label>
                        <select id="hiit-cooldown" class="select select-bordered">
                            <option value="0">0 min</option>
                            <option value="3">3 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="7">7 min</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Direcci√≥n</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="radio" name="hiit-direction" id="hiit-down" value="down" class="radio radio-primary" checked>
                            <label for="hiit-down">Descendente</label>
                            <input type="radio" name="hiit-direction" id="hiit-up" value="up" class="radio radio-primary">
                            <label for="hiit-up">Ascendente</label>
                        </div>
                    </div>
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¬øQu√© es HIIT?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">HIIT (High Intensity Interval Training): Alterna per√≠odos de ejercicio intenso con descanso. Este temporizador maneja calentamiento, ciclos de trabajo/descanso y enfriamiento.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-hiit">Cancelar</button>
                <button class="btn btn-primary" id="apply-hiit">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal TABATA -->
    <dialog id="config-tabata-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar TABATA</h3>
            <div class="py-4">
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Rondas</span>
                        </label>
                        <input type="number" id="tabata-rounds" class="input input-bordered" min="1" max="20" value="8">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trabajo (s)</span>
                        </label>
                        <input type="number" id="tabata-work" class="input input-bordered" min="5" max="60" value="20">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Descanso (s)</span>
                        </label>
                        <input type="number" id="tabata-rest" class="input input-bordered" min="5" max="60" value="10">
                    </div>
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¬øQu√© es TABATA?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">Protocolo de 20 segundos de trabajo intenso seguidos de 10 segundos de descanso, repetido por 8 rondas (4 minutos totales). Puedes personalizar estos valores.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-tabata">Cancelar</button>
                <button class="btn btn-primary" id="apply-tabata">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modo concentraci√≥n -->
    <div class="concentration-mode hidden" id="concentration-mode">
        <div class="minimize-btn-container">
            <button class="btn btn-ghost text-white" id="minimize-btn">
                <i class="fas fa-compress"></i>
            </button>
        </div>
        <div class="concentration-display" id="concentration-display"></div>
        <!-- Informaci√≥n de progreso -->
        <div class="progress-info" id="progress-info">
            <!-- Aqu√≠ se mostrar√° la informaci√≥n de progreso -->
        </div>
        <div class="concentration-controls flex gap-4 mt-4">
            <button class="btn btn-primary btn-circle" id="concentration-action-btn" aria-label="Iniciar temporizador" aria-pressed="false">
                <i class="fas fa-play"></i>
            </button>
            <button class="btn btn-secondary btn-circle" id="concentration-reset-btn" aria-label="Reiniciar temporizador">
                <i class="fas fa-undo"></i>
            </button>
        </div>
    </div>
    <!-- Overlay de cuenta regresiva -->
    <div class="countdown-overlay" id="countdown-overlay">
        <div class="countdown-number" id="countdown-number">3</div>
        <div class="countdown-text" id="countdown-text">¬°Listo para empezar!</div>
    </div>
    <!-- Plantillas para bloques -->
    <template id="main-block-template">
      <article
        class="card mb-2 shadow hover:shadow-lg transition-all duration-200 bg-base-300 border border-base-content/20 main-block"
      >
        <div class="card-body p-2 relative">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-grow">
              <button
                type="button"
                class="btn btn-xs btn-ghost mr-1"
                data-action="toggle-content"
              >
                ‚ñº
              </button>
              <h3
                class="font-bold text-base flex-grow cursor-pointer"
                data-action="edit-title"
              >
                Bloque
              </h3>
            </div>
            <button
              type="button"
              class="btn btn-xs btn-ghost ml-auto"
              aria-label="Eliminar bloque"
              data-action="delete-block"
            >
              √ó
            </button>
          </div>
          <div
            class="content hidden mt-2 pt-2 border-t border-base-content/10 flex flex-col gap-2"
          >
            <div class="flex items-center">
              <select
                class="select select-sm select-bordered w-full"
                data-field="repeat"
              ></select>
            </div>
            <h5 class="text-xs font-semibold">Sub Bloques de tiempo:</h5>
            <div
              class="sub-block-list-container block-list-container border border-dashed border-transparent rounded"
            ></div>
            <button
              type="button"
              class="btn btn-outline btn-xs w-full"
              data-action="add-sub-block"
            >
              + A√±adir Sub Bloque
            </button>
          </div>
        </div>
      </article>
    </template>
    <template id="sub-block-template">
      <article
        class="card mb-1 shadow hover:shadow-lg transition-all duration-200 bg-base-100 border border-base-content/10 block-item"
      >
        <div class="card-body p-1 pt-2 relative">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-grow">
              <button
                type="button"
                class="btn btn-xs btn-ghost mr-1"
                data-action="toggle-content"
              >
                ‚ñº
              </button>
              <h3
                class="text-sm font-medium flex-grow cursor-pointer"
                data-action="edit-title"
              >
                Sub Bloque
              </h3>
            </div>
            <button
              type="button"
              class="btn btn-xs btn-ghost ml-auto"
              aria-label="Eliminar bloque"
              data-action="delete-block"
            >
              √ó
            </button>
          </div>
          <div class="content hidden mt-1 pt-1 border-t border-base-content/10">
            <div class="flex flex-col gap-1">
              <div
                class="flex flex-wrap justify-evenly items-center gap-1 w-full min-w-0"
              >
                <div class="flex justify-center min-w-0 w-16">
                  <input
                    type="text"
                    placeholder="Tiempo"
                    class="input input-xs input-bordered min-w-[3rem] max-w-[4.5rem] text-center text-xs"
                    data-field="time"
                  />
                </div>
                <div class="flex justify-center min-w-0 w-16">
                  <input
                    type="text"
                    placeholder="Aviso"
                    class="input input-xs input-bordered min-w-[3rem] max-w-[4.5rem] text-center text-xs"
                    data-field="warning"
                  />
                </div>
                <div class="relative flex justify-center min-w-0">
                  <div class="absolute -top-3.5 left-10 z-20 tooltip tooltip-left tooltip-info tooltip-click" 
                       data-tip="Elige la direcci√≥n del tiempo: ascendente (sube) o descendente (baja).">
                    <button type="button" 
                            class="btn p-0 min-h-[0.85rem] h-[0.85rem] w-[0.85rem] 
                                   border border-base-content/20 bg-base-200 text-base-content/70 
                                   rounded-full hover:bg-base-300 hover:text-base-content 
                                   transition-all duration-150">
                      <i class="fas fa-info text-[0.55rem]"></i>
                    </button>
                  </div>
                  <div class="flex rounded-full border border-base-content/10 bg-base-100">
                    <button
                      type="button"
                      class="btn btn-ghost btn-xs text-base px-1 py-0.5 rounded-l-full !rounded-r-none"
                      data-action="set-direction"
                      data-value="up"
                    >
                      <i class="fas fa-arrow-up text-xs"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-ghost btn-xs text-base px-1 py-0.5 rounded-r-full !rounded-l-none"
                      data-action="set-direction"
                      data-value="down"
                    >
                      <i class="fas fa-arrow-down text-xs"></i>
                    </button>
                    <input type="hidden" data-field="direction" value="up" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </article>
    </template>
    <script>
        // Clase para manejar el display de 7 segmentos
        class SevenSegmentDisplay {
            constructor(containerId, isConcentrationMode = false) {
                this.container = document.getElementById(containerId);
                this.isConcentrationMode = isConcentrationMode;
                this.digitMap = [
                    ['a', 'b', 'c', 'd', 'e', 'f'],     // 0
                    ['b', 'c'],                          // 1
                    ['a', 'b', 'g', 'e', 'd'],          // 2
                    ['a', 'b', 'g', 'c', 'd'],          // 3
                    ['f', 'g', 'b', 'c'],               // 4
                    ['a', 'f', 'g', 'c', 'd'],          // 5
                    ['a', 'f', 'g', 'c', 'd', 'e'],     // 6
                    ['a', 'b', 'c'],                    // 7
                    ['a', 'b', 'c', 'd', 'e', 'f', 'g'],// 8
                    ['a', 'b', 'c', 'd', 'f', 'g']      // 9
                ];
                this.lastTimeStr = null;
                this.initDisplay();
            }
            
            initDisplay() {
                this.container.innerHTML = '';
                const digitContainer = document.createElement('div');
                digitContainer.className = 'digit-container flex';
                
                // Crear d√≠gitos y dos puntos en formato HH:MM:SS o MM:SS:CC
                for (let i = 0; i < 8; i++) {
                    if (i === 2 || i === 5) {
                        const colon = document.createElement('div');
                        colon.className = 'colon';
                        colon.innerHTML = '<div class="colon-dot"></div><div class="colon-dot"></div>';
                        digitContainer.appendChild(colon);
                    } else {
                        digitContainer.appendChild(this.createDigit());
                    }
                }
                
                this.container.appendChild(digitContainer);
                return this.container;
            }
            
            createDigit() {
                const digit = document.createElement('div');
                digit.className = 'digit relative';
                ['a', 'b', 'c', 'd', 'e', 'f', 'g'].forEach(seg => {
                    const segment = document.createElement('div');
                    segment.className = `segment segment-${seg}`;
                    digit.appendChild(segment);
                });
                return digit;
            }
            
            updateDigit(digit, num) {
                const segments = digit.querySelectorAll('.segment');
                segments.forEach(s => s.classList.remove('on'));
                if (num === ' ') return;
                this.digitMap[num].forEach(s => {
                    digit.querySelector(`.segment-${s}`).classList.add('on');
                });
            }
            
            updateDisplay(timeStr) {
                // Evitar actualizaciones innecesarias
                if (this.lastTimeStr === timeStr) return;
                this.lastTimeStr = timeStr;
                
                const digits = this.container.querySelectorAll('.digit');
                const timeChars = timeStr.replace(/:/g, '').split('');
                
                for (let i = 0; i < digits.length; i++) {
                    if (timeChars[i] === ' ') {
                        this.updateDigit(digits[i], ' ');
                    } else {
                        this.updateDigit(digits[i], parseInt(timeChars[i]));
                    }
                }
                
                // Parpadeo de los dos puntos
                const colons = this.container.querySelectorAll('.colon-dot');
                const now = new Date();
                const visible = this.isConcentrationMode ? 
                    (state.isTimerRunning && state.timerValue % 2 === 0) :
                    (state.activeProgram === 'clock' ? (now.getSeconds() % 2 === 0) : (state.isTimerRunning && state.timerValue % 2 === 0));
                
                colons.forEach(dot => dot.style.opacity = visible ? '0.8' : '0.3');
            }
        }

        // Clase para manejar la l√≥gica del temporizador
        class Timer {
            constructor() {
                this.initialTime = 0;
                this.currentTime = 0;
                this.direction = 'down';
                this.isRunning = false;
                this.interval = null;
                this.callbacks = [];
            }
            
            setConfig(initialTime, direction) {
                this.initialTime = initialTime;
                this.currentTime = initialTime;
                this.direction = direction;
            }
            
            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.interval = setInterval(() => {
                    this.tick();
                    this.notify();
                }, 1000);
            }
            
            tick() {
                if (this.direction === 'down' && this.currentTime > 0) {
                    this.currentTime--;
                } else if (this.direction === 'up') {
                    this.currentTime++;
                }
            }
            
            pause() {
                if (!this.isRunning) return;
                this.isRunning = false;
                clearInterval(this.interval);
            }
            
            reset() {
                this.pause();
                this.currentTime = this.initialTime;
                this.notify();
            }
            
            addObserver(callback) {
                this.callbacks.push(callback);
            }
            
            notify() {
                this.callbacks.forEach(callback => callback(this.currentTime));
            }
            
            destroy() {
                this.pause();
                this.callbacks = [];
            }
        }

        // Clase para manejar sonidos
        class SoundManager {
            constructor() {
                this.soundEnabled = true;
                this.startSound = null;
                this.endSound = null;
                this.initSounds();
            }
            
            initSounds() {
                // Sonido de inicio: tono suave de 440Hz durante 100ms
                this.startSound = this.createTone(440, 0.1);
                
                // Sonido de fin: tono suave de 880Hz durante 150ms
                this.endSound = this.createTone(880, 0.15);
            }
            
            createTone(frequency, duration) {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.value = frequency;
                
                gainNode.gain.value = 0.1;
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + duration);
                
                // Retornar un objeto que puede ser clonado
                return {
                    play: () => {
                        if (!this.soundEnabled) return;
                        
                        const newCtx = new (window.AudioContext || window.webkitAudioContext)();
                        const newOscillator = newCtx.createOscillator();
                        const newGainNode = newCtx.createGain();
                        
                        newOscillator.type = 'sine';
                        newOscillator.frequency.value = frequency;
                        
                        newGainNode.gain.value = 0.1;
                        newGainNode.gain.exponentialRampToValueAtTime(0.001, newCtx.currentTime + duration);
                        
                        newOscillator.connect(newGainNode);
                        newGainNode.connect(newCtx.destination);
                        
                        newOscillator.start();
                        newOscillator.stop(newCtx.currentTime + duration);
                    }
                };
            }
            
            playStartSound() {
                if (this.startSound) {
                    this.startSound.play();
                }
            }
            
            playEndSound() {
                if (this.endSound) {
                    this.endSound.play();
                }
            }
            
            setEnabled(enabled) {
                this.soundEnabled = enabled;
            }
        }

        // Estado de la aplicaci√≥n
        const state = {
            activeProgram: 'clock',
            timerValue: 0,
            isTimerRunning: false,
            timerInterval: null,
            countDirection: 'down',
            isConnected: false,
            editMode: false,
            stopwatchCentiseconds: 0,
            stopwatchInterval: null,
            isFullscreen: false,
            glowEffectEnabled: true,
            autoFullscreen: true,
            defaultCountdown: 3,
            countdownActive: false,
            countdownInterval: null,
            countdownValue: 0,
            programConfig: {
                'count-up': { maxTime: 300, current: 0 }, // Agregado 'current' para seguimiento
                'count-down': { initialTime: 300, current: 300 },
                'amrap': { duration: 300, current: 300 },
                'for-time': { maxTime: 600, current: 0 },
                'emom': { totalMinutes: 10, reps: 10, current: 600 },
                'hiit': { 
                    warmup: 5,
                    work: 20,
                    rest: 10,
                    rounds: 8,
                    cooldown: 5,
                    direction: 'down',
                    currentPhase: 'warmup',
                    currentRound: 0,
                    current: 300
                },
                'tabata': { rounds: 8, work: 20, rest: 10, currentRound: 0, current: 20 },
            },
            customPrograms: [],
            editingProgram: null,
            elements: {
                display: null,
                concentrationDisplay: null,
                progressInfo: null,
                actionBtn: null,
                resetBtn: null,
                concentrationActionBtn: null,
                concentrationResetBtn: null,
                programBtns: null,
                globalConfigBtn: null,
                editCorner: null,
                configModal: null,
                createProgramModal: null,
                themeSwitcher: null,
                customProgramBtn: null,
                fullscreenBtn: null,
                concentrationMode: null,
                minimizeBtn: null,
                programsContainer: null,
                glowEffectToggle: null,
                ledIntensity: null,
                autoFullscreenToggle: null,
                defaultCountdownSelect: null,
                countdownOverlay: null,
                countdownNumber: null,
                countdownText: null,
                soundToggle: null,
                exportProgramsBtn: null,
                importProgramsBtn: null,
                importFileInput: null,
                modalTitle: null,
                saveProgramBtn: null
            }
        };

        // Inicializar elementos
        function initElements() {
            const els = state.elements;
            els.display = new SevenSegmentDisplay('display');
            els.concentrationDisplay = new SevenSegmentDisplay('concentration-display', true);
            els.progressInfo = document.getElementById('progress-info');
            els.actionBtn = document.getElementById('action-btn');
            els.resetBtn = document.getElementById('reset-btn');
            els.concentrationActionBtn = document.getElementById('concentration-action-btn');
            els.concentrationResetBtn = document.getElementById('concentration-reset-btn');
            els.programBtns = document.querySelectorAll('.program-btn');
            els.globalConfigBtn = document.getElementById('global-config-btn');
            els.editCorner = document.getElementById('edit-corner');
            els.configModal = document.getElementById('config-modal');
            els.createProgramModal = document.getElementById('create-program-modal');
            els.themeSwitcher = document.getElementById('themeSwitcher');
            els.customProgramBtn = document.querySelector('.program-btn.custom');
            els.fullscreenBtn = document.getElementById('fullscreen-btn');
            els.concentrationMode = document.getElementById('concentration-mode');
            els.minimizeBtn = document.getElementById('minimize-btn');
            els.programsContainer = document.getElementById('programs-container');
            els.glowEffectToggle = document.getElementById('glow-effect-toggle');
            els.ledIntensity = document.getElementById('led-intensity');
            els.autoFullscreenToggle = document.getElementById('auto-fullscreen-toggle');
            els.defaultCountdownSelect = document.getElementById('default-countdown');
            els.countdownOverlay = document.getElementById('countdown-overlay');
            els.countdownNumber = document.getElementById('countdown-number');
            els.countdownText = document.getElementById('countdown-text');
            els.soundToggle = document.getElementById('sound-toggle');
            els.exportProgramsBtn = document.getElementById('export-programs-btn');
            els.importProgramsBtn = document.getElementById('import-programs-btn');
            els.importFileInput = document.getElementById('import-file-input');
            els.modalTitle = document.getElementById('modal-title');
            els.saveProgramBtn = document.getElementById('saveProgramBtn');
        }

        // Funciones de utilidad
        const utils = {
            timeToSeconds(timeStr) {
                const [mins, secs] = timeStr.split(':').map(Number);
                return (mins * 60) + secs;
            },
            
            secondsToTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            },
            
            formatTimeInput(input) {
                let v = input.value.replace(/\D/g, "").substring(0, 4);
                if (v.length > 2) v = v.substring(0, 2) + ":" + v.substring(2);
                input.value = v;
            },
            
            formatStopwatchTime(centiseconds) {
                const minutes = Math.floor(centiseconds / 6000);
                const remaining = centiseconds % 6000;
                const seconds = Math.floor(remaining / 100);
                const cents = remaining % 100;
                
                return `  ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(cents).padStart(2, '0')}`;
            },
            
            // Normaliza los programas para exportaci√≥n
            normalizeProgramsForExport() {
                return state.customPrograms.map(program => ({
                    id: program.id,
                    name: program.name,
                    description: program.description,
                    countdown: program.countdown,
                    initialTime: program.initialTime,
                    direction: program.direction,
                    blocks: program.blocks ? program.blocks.map(block => ({
                        name: block.name,
                        userEditedName: block.userEditedName,
                        repeat: block.repeat,
                        blocks: block.blocks ? block.blocks.map(subBlock => ({
                            name: subBlock.name,
                            userEditedName: subBlock.userEditedName,
                            time: subBlock.time,
                            warning: subBlock.warning,
                            direction: subBlock.direction
                        })) : []
                    })) : []
                }));
            },
            
            // Normaliza los programas importados
            normalizeImportedPrograms(programs) {
                return programs.map(program => ({
                    id: program.id || `custom-${Date.now()}`,
                    name: program.name || 'Programa personalizado',
                    description: program.description || '',
                    countdown: program.countdown || '0',
                    initialTime: program.initialTime || 300,
                    direction: program.direction || 'down',
                    blocks: program.blocks ? program.blocks.map(block => ({
                        name: block.name || 'Bloque',
                        userEditedName: block.userEditedName || false,
                        repeat: block.repeat || '1',
                        blocks: block.blocks ? block.blocks.map(subBlock => ({
                            name: subBlock.name || 'Sub Bloque',
                            userEditedName: subBlock.userEditedName || false,
                            time: subBlock.time || '00:00',
                            warning: subBlock.warning || '00:00',
                            direction: subBlock.direction || 'up'
                        })) : []
                    })) : []
                }));
            }
        };

        // Servicio de sonido
        const soundManager = new SoundManager();
        
        // L√≥gica de cuenta regresiva
        const countdownLogic = {
            startCountdown(duration, callback) {
                state.countdownValue = duration;
                state.countdownActive = true;
                state.elements.countdownNumber.textContent = duration;
                state.elements.countdownText.textContent = '¬°Listo para empezar!';
                state.elements.countdownOverlay.style.display = 'flex';
                
                state.countdownInterval = setInterval(() => {
                    state.countdownValue--;
                    
                    if (state.countdownValue > 0) {
                        state.elements.countdownNumber.textContent = state.countdownValue;
                    } else {
                        clearInterval(state.countdownInterval);
                        state.elements.countdownOverlay.style.display = 'none';
                        state.countdownActive = false;
                        callback();
                    }
                }, 1000);
            },
            
            cancelCountdown() {
                if (state.countdownActive) {
                    clearInterval(state.countdownInterval);
                    state.elements.countdownOverlay.style.display = 'none';
                    state.countdownActive = false;
                }
            }
        };

        // L√≥gica del temporizador
        const timerLogic = {
            updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                state.elements.display.updateDisplay(`${hours}:${minutes}:${seconds}`);
                state.elements.concentrationDisplay.updateDisplay(`${hours}:${minutes}:${seconds}`);
            },
            
            updateStopwatch() {
                state.elements.display.updateDisplay(utils.formatStopwatchTime(state.stopwatchCentiseconds));
                state.elements.concentrationDisplay.updateDisplay(utils.formatStopwatchTime(state.stopwatchCentiseconds));
            },
            
            updateTimerDisplay() {
                if (state.activeProgram === 'clock') return;
                
                if (state.activeProgram === 'stopwatch') {
                    this.updateStopwatch();
                    return;
                }
                
                const mins = Math.floor(state.timerValue / 60);
                const secs = state.timerValue % 60;
                const timeStr = `  ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}:00`;
                
                state.elements.display.updateDisplay(timeStr);
                state.elements.concentrationDisplay.updateDisplay(timeStr);
            },
            
            startTimer() {
                if (state.isTimerRunning) return;
                
                // Verificar si se necesita una cuenta regresiva
                let countdownDuration = 0;
                const currentProgram = state.activeProgram;
                
                if (currentProgram === 'clock') {
                    // No se aplica cuenta regresiva al reloj
                    this._startTimerInternal();
                    return;
                }
                
                // Buscar en programas personalizados
                if (currentProgram.startsWith('custom-')) {
                    const customId = currentProgram.split('-')[1];
                    const customProgram = state.customPrograms.find(p => p.id === customId);
                    if (customProgram && customProgram.countdown && customProgram.countdown > 0) {
                        countdownDuration = parseInt(customProgram.countdown);
                    }
                } 
                // Para programas predefinidos
                else if (state.programConfig[currentProgram] && 
                         state.programConfig[currentProgram].hasOwnProperty('countdown') && 
                         state.programConfig[currentProgram].countdown > 0) {
                    countdownDuration = state.programConfig[currentProgram].countdown;
                }
                // Si no tiene cuenta regresiva propia, usar la por defecto
                else {
                    countdownDuration = state.defaultCountdown;
                }
                
                // Iniciar cuenta regresiva si es necesario
                if (countdownDuration > 0) {
                    countdownLogic.startCountdown(countdownDuration, () => {
                        this._startTimerInternal();
                    });
                } else {
                    this._startTimerInternal();
                }
            },
            
            _startTimerInternal() {
                state.isTimerRunning = true;
                state.elements.actionBtn.textContent = 'Pausar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'true');
                state.elements.concentrationActionBtn.innerHTML = '<i class="fas fa-pause"></i>';
                state.elements.concentrationActionBtn.setAttribute('aria-pressed', 'true');
                
                // Activar modo concentraci√≥n para programas de temporizador
                if (state.autoFullscreen && state.activeProgram !== 'clock') {
                    state.isFullscreen = true;
                    state.elements.concentrationMode.classList.remove('hidden');
                }
                
                // Deshabilitar otros programas
                state.elements.programBtns.forEach(btn => {
                    if (btn.dataset.program !== state.activeProgram) {
                        btn.style.pointerEvents = 'none';
                        btn.style.opacity = '0.6';
                    } else {
                        btn.classList.add('running');
                    }
                });
                
                // Reproducir sonido de inicio
                soundManager.playStartSound();
                
                if (state.activeProgram === 'stopwatch') {
                    state.stopwatchCentiseconds = 0;
                    state.stopwatchInterval = setInterval(() => {
                        state.stopwatchCentiseconds++;
                        this.updateStopwatch();
                    }, 10); // Intervalo de 10ms para cent√©simas
                } else {
                    state.timerInterval = setInterval(() => {
                        this._tickProgram();
                    }, 1000);
                }
            },
            
            _tickProgram() {
                const program = state.activeProgram;
                const config = state.programConfig[program];
                
                switch(program) {
                    case 'count-up':
                        if (state.timerValue >= config.maxTime) {
                            this._stopProgram();
                        } else {
                            state.timerValue++;
                            this.updateTimerDisplay();
                            this._updateProgressInfo(program);
                        }
                        break;
                    case 'count-down':
                        if (state.timerValue <= 0) {
                            this._stopProgram();
                        } else {
                            state.timerValue--;
                            this.updateTimerDisplay();
                            this._updateProgressInfo(program);
                        }
                        break;
                    case 'amrap':
                        if (state.timerValue <= 0) {
                            this._stopProgram();
                        } else {
                            state.timerValue--;
                            this.updateTimerDisplay();
                            this._updateProgressInfo(program);
                        }
                        break;
                    case 'for-time':
                        state.timerValue++;
                        this.updateTimerDisplay();
                        this._updateProgressInfo(program);
                        break;
                    case 'emom':
                        if (state.timerValue <= 0) {
                            this._stopProgram();
                        } else {
                            state.timerValue--;
                            this.updateTimerDisplay();
                            this._updateProgressInfo(program);
                        }
                        break;
                    case 'hiit':
                        this._tickHiit();
                        break;
                    case 'tabata':
                        this._tickTabata();
                        break;
                    default:
                        if (program.startsWith('custom-')) {
                            this._tickCustom();
                        }
                }
            },
            
            _tickHiit() {
                const config = state.programConfig.hiit;
                const phaseDurations = {
                    'warmup': config.warmup * 60,
                    'work': config.work,
                    'rest': config.rest,
                    'cooldown': config.cooldown * 60
                };
                
                // Si estamos en la fase de calentamiento
                if (config.currentPhase === 'warmup') {
                    if (state.timerValue <= 0) {
                        // Pasar a la fase de trabajo
                        config.currentPhase = 'work';
                        state.timerValue = config.work;
                    } else {
                        state.timerValue--;
                    }
                } 
                // Si estamos en la fase de trabajo
                else if (config.currentPhase === 'work') {
                    if (state.timerValue <= 0) {
                        // Pasar a la fase de descanso
                        config.currentPhase = 'rest';
                        state.timerValue = config.rest;
                    } else {
                        state.timerValue--;
                    }
                }
                // Si estamos en la fase de descanso
                else if (config.currentPhase === 'rest') {
                    if (state.timerValue <= 0) {
                        // Incrementar ronda
                        config.currentRound++;
                        
                        // Si terminaron todas las rondas
                        if (config.currentRound >= config.rounds) {
                            // Pasar a enfriamiento
                            config.currentPhase = 'cooldown';
                            state.timerValue = config.cooldown * 60;
                        } else {
                            // Volver a trabajo
                            config.currentPhase = 'work';
                            state.timerValue = config.work;
                        }
                    } else {
                        state.timerValue--;
                    }
                }
                // Si estamos en la fase de enfriamiento
                else if (config.currentPhase === 'cooldown') {
                    if (state.timerValue <= 0) {
                        this._stopProgram();
                    } else {
                        state.timerValue--;
                    }
                }
                
                this.updateTimerDisplay();
                this._updateProgressInfo('hiit');
            },
            
            _tickTabata() {
                const config = state.programConfig.tabata;
                const totalRounds = config.rounds * 2;
                
                if (state.timerValue <= 0) {
                    // Incrementar ronda
                    config.currentRound++;
                    
                    // Si terminaron todas las rondas
                    if (config.currentRound >= totalRounds) {
                        this._stopProgram();
                        return;
                    }
                    
                    // Cambiar entre trabajo y descanso
                    if (config.currentRound % 2 === 0) {
                        // Tiempo de descanso
                        state.timerValue = config.rest;
                    } else {
                        // Tiempo de trabajo
                        state.timerValue = config.work;
                    }
                } else {
                    state.timerValue--;
                }
                
                this.updateTimerDisplay();
                this._updateProgressInfo('tabata');
            },
            
            _tickCustom() {
                const config = state.programConfig[state.activeProgram];
                const customId = state.activeProgram.split('-')[1];
                const customProgram = state.customPrograms.find(p => p.id === customId);
                
                if (!customProgram || !customProgram.blocks || customProgram.blocks.length === 0) {
                    this._stopProgram();
                    return;
                }
                
                // Manejar la l√≥gica de bloques personalizados
                if (!config.currentBlock) {
                    config.currentBlock = {
                        mainBlockIndex: 0,
                        mainBlockRepeat: 0,
                        subBlockIndex: 0,
                        subBlockRepeat: 0,
                        totalTime: 0
                    };
                }
                
                const mainBlock = customProgram.blocks[config.currentBlock.mainBlockIndex];
                const subBlock = mainBlock.blocks[config.currentBlock.subBlockIndex];
                const timeSecs = utils.timeToSeconds(subBlock.time);
                
                // Incrementar el tiempo total
                config.currentBlock.totalTime++;
                
                // Si el tiempo actual es igual al tiempo del sub-bloque
                if (config.currentBlock.totalTime >= timeSecs) {
                    // Reiniciar el contador de tiempo
                    config.currentBlock.totalTime = 0;
                    
                    // Incrementar el sub-bloque
                    config.currentBlock.subBlockRepeat++;
                    
                    // Si ya complet√≥ todas las repeticiones del sub-bloque
                    if (config.currentBlock.subBlockRepeat >= parseInt(subBlock.repeat || 1)) {
                        config.currentBlock.subBlockRepeat = 0;
                        config.currentBlock.subBlockIndex++;
                        
                        // Si ya complet√≥ todos los sub-bloques
                        if (config.currentBlock.subBlockIndex >= mainBlock.blocks.length) {
                            config.currentBlock.subBlockIndex = 0;
                            config.currentBlock.mainBlockRepeat++;
                            
                            // Si ya complet√≥ todas las repeticiones del bloque principal
                            if (config.currentBlock.mainBlockRepeat >= parseInt(mainBlock.repeat || 1)) {
                                config.currentBlock.mainBlockRepeat = 0;
                                config.currentBlock.mainBlockIndex++;
                                
                                // Si ya complet√≥ todos los bloques principales
                                if (config.currentBlock.mainBlockIndex >= customProgram.blocks.length) {
                                    this._stopProgram();
                                    return;
                                }
                            }
                        }
                    }
                }
                
                // Actualizar el tiempo actual
                if (subBlock.direction === 'down') {
                    if (state.timerValue <= 0) {
                        // Deber√≠amos pasar al siguiente sub-bloque, pero ya lo manejamos arriba
                        state.timerValue = timeSecs;
                    } else {
                        state.timerValue--;
                    }
                } else {
                    state.timerValue++;
                }
                
                this.updateTimerDisplay();
                this._updateProgressInfo('custom');
            },
            
            _updateProgressInfo(program) {
                const progressInfo = state.elements.progressInfo;
                if (!progressInfo) return;
                
                // Solo mostrar informaci√≥n para programas que realmente necesitan
                switch(program) {
                    case 'hiit':
                        const hiitConfig = state.programConfig.hiit;
                        let phaseText = '';
                        
                        switch(hiitConfig.currentPhase) {
                            case 'warmup':
                                phaseText = 'Calentamiento';
                                break;
                            case 'work':
                                phaseText = 'Trabajo';
                                break;
                            case 'rest':
                                phaseText = 'Descanso';
                                break;
                            case 'cooldown':
                                phaseText = 'Enfriamiento';
                                break;
                        }
                        
                        progressInfo.textContent = `Fase: ${phaseText} | Ronda: ${hiitConfig.currentRound + 1}/${hiitConfig.rounds}`;
                        break;
                    case 'tabata':
                        const tabataConfig = state.programConfig.tabata;
                        const totalRounds = tabataConfig.rounds * 2;
                        const currentRound = tabataConfig.currentRound + 1;
                        const phase = (tabataConfig.currentRound % 2 === 0) ? 'Trabajo' : 'Descanso';
                        
                        progressInfo.textContent = `Ronda: ${Math.floor(currentRound / 2) + 1}/${tabataConfig.rounds} | ${phase}`;
                        break;
                    case 'emom':
                        const emomTotal = state.programConfig.emom.totalMinutes * 60;
                        const emomRemaining = state.timerValue;
                        const emomMinutes = Math.floor(emomRemaining / 60);
                        const emomSeconds = emomRemaining % 60;
                        progressInfo.textContent = `Tiempo restante: ${String(emomMinutes).padStart(2, '0')}:${String(emomSeconds).padStart(2, '0')}`;
                        break;
                    case 'custom':
                        const customId = state.activeProgram.split('-')[1];
                        const customProgram = state.customPrograms.find(p => p.id === customId);
                        const config = state.programConfig[state.activeProgram];
                        
                        if (customProgram && config.currentBlock) {
                            const mainBlock = customProgram.blocks[config.currentBlock.mainBlockIndex];
                            const subBlock = mainBlock.blocks[config.currentBlock.subBlockIndex];
                            
                            let mainBlockText = mainBlock.name;
                            if (mainBlock.userEditedName) {
                                mainBlockText = mainBlock.name;
                            } else {
                                mainBlockText = `Bloque ${config.currentBlock.mainBlockIndex + 1}`;
                            }
                            
                            let subBlockText = subBlock.name;
                            if (subBlock.userEditedName) {
                                subBlockText = subBlock.name;
                            } else {
                                subBlockText = `Sub Bloque ${config.currentBlock.subBlockIndex + 1}`;
                            }
                            
                            progressInfo.textContent = `${mainBlockText} > ${subBlockText}`;
                        }
                        break;
                    default:
                        // Para otros programas, no mostramos informaci√≥n adicional
                        progressInfo.textContent = '';
                }
            },
            
            _stopProgram() {
                this.pauseTimer();
                soundManager.playEndSound();
                state.elements.progressInfo.textContent = '';
            },
            
            pauseTimer() {
                if (state.activeProgram === 'stopwatch') {
                    clearInterval(state.stopwatchInterval);
                } else {
                    clearInterval(state.timerInterval);
                }
                
                state.isTimerRunning = false;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                state.elements.concentrationActionBtn.innerHTML = '<i class="fas fa-play"></i>';
                state.elements.concentrationActionBtn.setAttribute('aria-pressed', 'false');
                
                // Habilitar programas
                state.elements.programBtns.forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '1';
                    btn.classList.remove('running');
                });
            },
            
            resetTimer() {
                if (state.isTimerRunning) {
                    this.pauseTimer();
                }
                
                // Resetear seg√∫n el programa activo
                switch(state.activeProgram) {
                    case 'clock':
                        // El reloj no se resetea, solo actualizamos
                        this.updateClock();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'stopwatch':
                        state.stopwatchCentiseconds = 0;
                        this.updateStopwatch();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'count-up':
                        state.timerValue = 0;
                        this.updateTimerDisplay();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'count-down':
                        state.timerValue = state.programConfig['count-down'].initialTime;
                        this.updateTimerDisplay();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'for-time':
                        state.timerValue = 0;
                        this.updateTimerDisplay();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'amrap':
                        state.timerValue = state.programConfig['amrap'].duration;
                        this.updateTimerDisplay();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'emom':
                        state.timerValue = state.programConfig['emom'].totalMinutes * 60;
                        this.updateTimerDisplay();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'hiit':
                        // Reiniciar configuraci√≥n HIIT
                        const hiitConfig = state.programConfig.hiit;
                        hiitConfig.currentPhase = 'warmup';
                        hiitConfig.currentRound = 0;
                        state.timerValue = hiitConfig.warmup * 60;
                        this.updateTimerDisplay();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'tabata':
                        // Reiniciar configuraci√≥n TABATA
                        const tabataConfig = state.programConfig.tabata;
                        tabataConfig.currentRound = 0;
                        state.timerValue = tabataConfig.work;
                        this.updateTimerDisplay();
                        state.elements.progressInfo.textContent = '';
                        break;
                    default:
                        if (state.activeProgram.startsWith('custom-')) {
                            const customId = state.activeProgram.split('-')[1];
                            const customProgram = state.customPrograms.find(p => p.id === customId);
                            if (customProgram) {
                                // Reiniciar configuraci√≥n del programa personalizado
                                const config = state.programConfig[state.activeProgram];
                                config.currentBlock = {
                                    mainBlockIndex: 0,
                                    mainBlockRepeat: 0,
                                    subBlockIndex: 0,
                                    subBlockRepeat: 0,
                                    totalTime: 0
                                };
                                
                                // Obtener el primer sub-bloque
                                const firstMainBlock = customProgram.blocks[0];
                                const firstSubBlock = firstMainBlock.blocks[0];
                                const timeSecs = utils.timeToSeconds(firstSubBlock.time);
                                
                                state.countDirection = firstSubBlock.direction || 'down';
                                state.timerValue = timeSecs;
                                this.updateTimerDisplay();
                                state.elements.progressInfo.textContent = '';
                            }
                        }
                }
            }
        };

        // L√≥gica de programas
        const programLogic = {
            setProgram(program) {
                state.activeProgram = program;
                
                // Actualizar clases de botones
                state.elements.programBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.program === program);
                    btn.classList.toggle('bg-base-200', btn.dataset.program !== program);
                });
                
                if (state.isTimerRunning) {
                    timerLogic.pauseTimer();
                }
                
                switch(program) {
                    case 'clock':
                        state.elements.actionBtn.textContent = state.isConnected ? 'Desconectar dispositivo' : 'Enviar al dispositivo';
                        state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                        state.elements.concentrationActionBtn.setAttribute('aria-pressed', 'false');
                        timerLogic.updateClock();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'stopwatch':
                        this.setupStopwatch();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'count-up':
                        this.setupCountUp();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'count-down':
                        this.setupCountDown();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'for-time':
                        this.setupForTime();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'amrap':
                        this.setupAmrap();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'emom':
                        this.setupEmom();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'hiit':
                        this.setupHiit();
                        state.elements.progressInfo.textContent = '';
                        break;
                    case 'tabata':
                        this.setupTabata();
                        state.elements.progressInfo.textContent = '';
                        break;
                    default:
                        if (program.startsWith('custom-')) {
                            this.setupCustomProgram(program);
                        }
                }
            },
            
            setupStopwatch() {
                state.countDirection = 'up';
                state.timerValue = 0;
                state.stopwatchCentiseconds = 0;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateStopwatch();
            },
            
            setupCountUp() {
                state.countDirection = 'up';
                state.timerValue = 0;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateTimerDisplay();
            },
            
            setupCountDown() {
                state.countDirection = 'down';
                state.timerValue = state.programConfig['count-down'].initialTime;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateTimerDisplay();
            },
            
            setupForTime() {
                state.countDirection = 'up';
                state.timerValue = 0;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateTimerDisplay();
            },
            
            setupAmrap() {
                state.countDirection = 'down';
                state.timerValue = state.programConfig['amrap'].duration;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateTimerDisplay();
            },
            
            setupEmom() {
                state.countDirection = 'down';
                state.timerValue = state.programConfig['emom'].totalMinutes * 60;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateTimerDisplay();
            },
            
            setupHiit() {
                state.countDirection = state.programConfig['hiit'].direction;
                const hiitConfig = state.programConfig.hiit;
                hiitConfig.currentPhase = 'warmup';
                hiitConfig.currentRound = 0;
                state.timerValue = hiitConfig.warmup * 60;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateTimerDisplay();
            },
            
            setupTabata() {
                state.countDirection = 'down';
                const tabataConfig = state.programConfig.tabata;
                tabataConfig.currentRound = 0;
                state.timerValue = tabataConfig.work;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                timerLogic.updateTimerDisplay();
            },
            
            setupCustomProgram(program) {
                const customId = program.split('-')[1];
                const customProgram = state.customPrograms.find(p => p.id === customId);
                if (customProgram) {
                    // Configurar el estado para el programa personalizado
                    if (!state.programConfig[program]) {
                        state.programConfig[program] = {
                            currentBlock: {
                                mainBlockIndex: 0,
                                mainBlockRepeat: 0,
                                subBlockIndex: 0,
                                subBlockRepeat: 0,
                                totalTime: 0
                            }
                        };
                    }
                    
                    // Obtener el primer sub-bloque
                    const firstMainBlock = customProgram.blocks[0];
                    const firstSubBlock = firstMainBlock.blocks[0];
                    const timeSecs = utils.timeToSeconds(firstSubBlock.time);
                    
                    state.countDirection = firstSubBlock.direction || 'down';
                    state.timerValue = timeSecs;
                    state.elements.actionBtn.textContent = 'Iniciar';
                    state.elements.actionBtn.setAttribute('aria-pressed', 'false');
                    timerLogic.updateTimerDisplay();
                }
            }
        };

        // Gesti√≥n de programas personalizados
        const customPrograms = {
            createCustomProgramCard(program) {
                const card = document.createElement('div');
                card.className = 'program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all custom-program-card';
                card.dataset.program = `custom-${program.id}`;
                
                const title = document.createElement('div');
                title.className = 'btn-text';
                title.textContent = program.name;
                
                const info = document.createElement('div');
                info.className = 'program-info';
                info.textContent = program.description || 'Programa personalizado';
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-custom';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteCustomProgram(program.id);
                });
                
                card.appendChild(title);
                card.appendChild(info);
                card.appendChild(deleteBtn);
                state.elements.programsContainer.insertBefore(card, state.elements.customProgramBtn);
                
                // Evento para seleccionar el programa
                card.addEventListener('click', () => {
                    if (state.editMode) {
                        // En modo edici√≥n, mostrar modal de edici√≥n
                        this.editCustomProgram(program);
                    } else {
                        programLogic.setProgram(`custom-${program.id}`);
                    }
                });
            },
            
            editCustomProgram(program) {
                state.editingProgram = program;
                state.elements.modalTitle.textContent = 'Editar programa';
                state.elements.saveProgramBtn.textContent = 'Actualizar';
                
                // Limpiar el bloque list
                document.getElementById('blockList').innerHTML = '';
                
                // Cargar los datos del programa en el modal
                document.getElementById('program-name').value = program.name;
                document.getElementById('program-description').value = program.description || '';
                document.getElementById('countdown').value = program.countdown || '0';
                
                // Crear los bloques
                if (program.blocks && program.blocks.length > 0) {
                    program.blocks.forEach(block => {
                        document.getElementById('blockList').appendChild(
                            this.createMainBlockForEdit(block)
                        );
                    });
                } else {
                    // A√±adir un bloque vac√≠o si no hay
                    document.getElementById('blockList').appendChild(
                        this.createMainBlockForEdit()
                    );
                }
                
                // Mostrar el modal
                state.elements.createProgramModal.showModal();
            },
            
            createMainBlockForEdit(blockData = {}) {
                const template = document.getElementById('main-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                const select = clone.querySelector('[data-field="repeat"]');
                
                let repeatOptions = '<option value="1">No repetir este bloque</option>';
                for (let i = 2; i <= 99; i++) repeatOptions += `<option value="${i}">Repetir ${i} veces</option>`;
                select.innerHTML = repeatOptions;
                
                if (blockData.name) title.textContent = blockData.name;
                if (blockData.userEditedName) title.dataset.userEdited = "true";
                select.value = blockData.repeat || 1;
                
                const subBlockContainer = clone.querySelector(".sub-block-list-container");
                if (blockData.blocks && blockData.blocks.length > 0) {
                    blockData.blocks.forEach(subBlockData => subBlockContainer.appendChild(
                        this.createSubBlockForEdit(subBlockData)
                    ));
                } else {
                    subBlockContainer.appendChild(this.createSubBlockForEdit());
                }
                
                return clone;
            },
            
            createSubBlockForEdit(subBlockData = {}) {
                const template = document.getElementById('sub-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                if (subBlockData.name) title.textContent = subBlockData.name;
                if (subBlockData.userEditedName) title.dataset.userEdited = "true";
                clone.querySelector('[data-field="time"]').value = subBlockData.time || "";
                clone.querySelector('[data-field="warning"]').value = subBlockData.warning || "";
                const direction = subBlockData.direction || "up";
                clone.querySelector('[data-field="direction"]').value = direction;
                const dirButton = clone.querySelector(`[data-action="set-direction"][data-value="${direction}"]`);
                if (dirButton) dirButton.classList.add("bg-primary", "text-primary-content");
                return clone;
            },
            
            deleteCustomProgram(id) {
                state.customPrograms = state.customPrograms.filter(p => p.id !== id);
                document.querySelector(`[data-program="custom-${id}"]`).remove();
                this.saveCustomPrograms();
            },
            
            saveCustomPrograms() {
                localStorage.setItem('customPrograms', JSON.stringify(state.customPrograms));
            },
            
            loadCustomPrograms() {
                const saved = localStorage.getItem('customPrograms');
                if (saved) {
                    state.customPrograms = JSON.parse(saved);
                    state.customPrograms.forEach(p => this.createCustomProgramCard(p));
                }
            },
            
            exportPrograms() {
                const normalizedPrograms = utils.normalizeProgramsForExport();
                const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(normalizedPrograms, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "fitness-timer-programs.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },
            
            importPrograms(file) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const importedPrograms = JSON.parse(e.target.result);
                        const normalizedPrograms = utils.normalizeImportedPrograms(importedPrograms);
                        
                        // Eliminar programas personalizados existentes
                        state.customPrograms = [];
                        document.querySelectorAll('.custom-program-card').forEach(card => {
                            card.remove();
                        });
                        
                        // Agregar los nuevos programas
                        state.customPrograms = normalizedPrograms;
                        state.customPrograms.forEach(p => this.createCustomProgramCard(p));
                        
                        this.saveCustomPrograms();
                        
                        // Mostrar mensaje de √©xito
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-success fixed bottom-4 right-4 z-50';
                        notification.textContent = `${normalizedPrograms.length} programas importados correctamente`;
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.remove();
                        }, 3000);
                    } catch (error) {
                        // Mostrar mensaje de error
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-error fixed bottom-4 right-4 z-50';
                        notification.textContent = 'Error al importar programas: archivo inv√°lido';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.remove();
                        }, 3000);
                    }
                };
                
                reader.readAsText(file);
            }
        };

        // Inicializaci√≥n del modal de creaci√≥n/edici√≥n de programas
        function initProgramCreationModal() {
            const blockList = document.getElementById('blockList');
            
            const createSubBlock = (data = {}) => {
                const template = document.getElementById('sub-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                if (data.name) title.textContent = data.name;
                if (data.userEditedName) title.dataset.userEdited = "true";
                clone.querySelector('[data-field="time"]').value = data.time || "";
                clone.querySelector('[data-field="warning"]').value = data.warning || "";
                const direction = data.direction || "up";
                clone.querySelector('[data-field="direction"]').value = direction;
                const dirButton = clone.querySelector(`[data-action="set-direction"][data-value="${direction}"]`);
                if (dirButton) dirButton.classList.add("bg-primary", "text-primary-content");
                return clone;
            };
            
            const createMainBlock = (data = {}) => {
                const template = document.getElementById('main-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                const select = clone.querySelector('[data-field="repeat"]');
                
                let repeatOptions = '<option value="1">No repetir este bloque</option>';
                for (let i = 2; i <= 99; i++) repeatOptions += `<option value="${i}">Repetir ${i} veces</option>`;
                select.innerHTML = repeatOptions;
                
                if (data.name) title.textContent = data.name;
                if (data.userEditedName) title.dataset.userEdited = "true";
                select.value = data.repeat || 1;
                
                const subBlockContainer = clone.querySelector(".sub-block-list-container");
                if (data.blocks && data.blocks.length > 0) {
                    data.blocks.forEach(subBlockData => subBlockContainer.appendChild(createSubBlock(subBlockData)));
                } else {
                    subBlockContainer.appendChild(createSubBlock());
                }
                
                return clone;
            };
            
            // Renumerar bloques para mantener el orden
            const renumberBlocks = () => {
                let mainBlockCount = 0;
                blockList.querySelectorAll(":scope > .main-block").forEach(mainBlock => {
                    mainBlockCount++;
                    const title = mainBlock.querySelector('[data-action="edit-title"]');
                    if (!title.dataset.userEdited) {
                        title.textContent = `Bloque ${mainBlockCount}`;
                    }
                    
                    let subBlockCount = 0;
                    mainBlock.querySelectorAll(".sub-block-list-container > .block-item").forEach(subBlock => {
                        subBlockCount++;
                        const subTitle = subBlock.querySelector('[data-action="edit-title"]');
                        if (!subTitle.dataset.userEdited) {
                            subTitle.textContent = `Sub Bloque ${subBlockCount}`;
                        }
                    });
                });
            };
            
            blockList.addEventListener("click", (e) => {
                const button = e.target.closest("[data-action]");
                if (!button) return;
                
                const action = button.dataset.action;
                const block = button.closest(".main-block, .block-item");
                
                switch (action) {
                    case "delete-block":
                        block.remove();
                        renumberBlocks();
                        break;
                    case "toggle-content":
                        const content = block.querySelector(".content");
                        content.classList.toggle("hidden");
                        button.innerHTML = content.classList.contains("hidden") ? "‚ñº" : "‚ñ≤";
                        break;
                    case "add-sub-block":
                        block.querySelector(".sub-block-list-container").appendChild(createSubBlock());
                        renumberBlocks();
                        break;
                    case "edit-title":
                        if (button.querySelector("input")) return;
                        const currentText = button.textContent;
                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = currentText;
                        input.className = "input input-ghost input-xs w-full";
                        input.addEventListener("blur", () => {
                            const newValue = input.value.trim() || currentText;
                            button.textContent = newValue;
                            if (newValue && !newValue.match(/^(Bloque|Sub Bloque) \d+$/i)) {
                                button.dataset.userEdited = "true";
                            } else {
                                delete button.dataset.userEdited;
                            }
                            renumberBlocks();
                        });
                        input.addEventListener("keydown", (e) => e.key === "Enter" && e.target.blur());
                        button.innerHTML = "";
                        button.appendChild(input);
                        input.focus();
                        break;
                    case "set-direction":
                        const parent = button.parentElement;
                        parent.querySelectorAll("button").forEach(btn => 
                            btn.classList.remove("bg-primary", "text-primary-content")
                        );
                        button.classList.add("bg-primary", "text-primary-content");
                        parent.querySelector('input[data-field="direction"]').value = button.dataset.value;
                        break;
                }
            });
            
            blockList.addEventListener("focusin", (e) => {
                if (e.target.matches('[data-field="time"], [data-field="warning"]') && !e.target.value) {
                    e.target.value = "00:00";
                }
            });
            
            blockList.addEventListener("input", (e) => {
                if (e.target.matches('[data-field="time"], [data-field="warning"]')) {
                    utils.formatTimeInput(e.target);
                }
            });
            
            document.getElementById('addMainBlockBtn').addEventListener("click", () => {
                blockList.appendChild(createMainBlock());
                renumberBlocks();
            });
            
            document.getElementById('cancelCreate').addEventListener("click", () => {
                state.elements.createProgramModal.close();
            });
            
            document.getElementById('programForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const programName = document.getElementById('program-name').value;
                const programId = state.editingProgram ? state.editingProgram.id : 'custom-' + Date.now();
                
                // Obtener la estructura de bloques
                const blocks = [];
                blockList.querySelectorAll('.main-block').forEach(mainBlock => {
                    const mainBlockTitle = mainBlock.querySelector('[data-action="edit-title"]');
                    const repeat = mainBlock.querySelector('[data-field="repeat"]').value;
                    
                    const subBlocks = [];
                    mainBlock.querySelectorAll('.block-item').forEach(subBlock => {
                        const subBlockTitle = subBlock.querySelector('[data-action="edit-title"]');
                        const time = subBlock.querySelector('[data-field="time"]').value;
                        const warning = subBlock.querySelector('[data-field="warning"]').value;
                        const direction = subBlock.querySelector('[data-field="direction"]').value;
                        
                        subBlocks.push({
                            name: subBlockTitle.textContent,
                            userEditedName: !!subBlockTitle.dataset.userEdited,
                            time: time || '00:00',
                            warning: warning || '00:00',
                            direction: direction || 'up'
                        });
                    });
                    
                    blocks.push({
                        name: mainBlockTitle.textContent,
                        userEditedName: !!mainBlockTitle.dataset.userEdited,
                        repeat: repeat,
                        blocks: subBlocks
                    });
                });
                
                // Crear o actualizar el programa
                const program = {
                    id: programId,
                    name: programName,
                    description: document.getElementById('program-description').value,
                    countdown: document.getElementById('countdown').value,
                    initialTime: 300,
                    direction: 'down',
                    blocks: blocks
                };
                
                if (state.editingProgram) {
                    // Actualizar programa existente
                    const index = state.customPrograms.findIndex(p => p.id === programId);
                    if (index !== -1) {
                        state.customPrograms[index] = program;
                    }
                } else {
                    // Crear nuevo programa
                    state.customPrograms.push(program);
                }
                
                // Actualizar UI
                if (state.editingProgram) {
                    // Actualizar tarjeta existente
                    const card = document.querySelector(`[data-program="custom-${programId}"]`);
                    if (card) {
                        const title = card.querySelector('.btn-text');
                        const info = card.querySelector('.program-info');
                        title.textContent = programName;
                        info.textContent = program.description || 'Programa personalizado';
                    }
                } else {
                    // Crear nueva tarjeta
                    customPrograms.createCustomProgramCard(program);
                }
                
                // Guardar y cerrar
                customPrograms.saveCustomPrograms();
                state.elements.createProgramModal.close();
                state.editingProgram = null;
                document.getElementById('programForm').reset();
                blockList.innerHTML = '';
            });
        }

        // Configuraci√≥n de eventos
        function setupEventListeners() {
            // Bot√≥n de acci√≥n principal
            state.elements.actionBtn.addEventListener('click', () => {
                if (state.countdownActive) {
                    countdownLogic.cancelCountdown();
                    return;
                }
                
                if (state.activeProgram === 'clock') {
                    state.isConnected = !state.isConnected;
                    state.elements.actionBtn.textContent = state.isConnected ? 
                        'Desconectar dispositivo' : 'Enviar al dispositivo';
                    state.elements.actionBtn.setAttribute('aria-pressed', state.isConnected.toString());
                } else {
                    state.isTimerRunning ? timerLogic.pauseTimer() : timerLogic.startTimer();
                }
            });
            
            // Bot√≥n de reset
            state.elements.resetBtn.addEventListener('click', () => {
                if (state.countdownActive) {
                    countdownLogic.cancelCountdown();
                } else {
                    timerLogic.resetTimer();
                }
            });
            
            // Bot√≥n de reset en modo concentraci√≥n
            state.elements.concentrationResetBtn.addEventListener('click', () => {
                timerLogic.resetTimer();
            });
            
            // Modo edici√≥n
            state.elements.editCorner.addEventListener('click', () => {
                state.editMode = !state.editMode;
                document.body.classList.toggle('edit-mode', state.editMode);
                const editIcon = state.elements.editCorner.querySelector('i');
                editIcon.className = state.editMode ? 'fas fa-check' : 'fas fa-pencil-alt';
                state.elements.customProgramBtn.classList.toggle('hidden', !state.editMode);
                
                // Mostrar u ocultar botones de eliminar
                document.querySelectorAll('.delete-custom').forEach(btn => {
                    btn.style.display = state.editMode ? 'flex' : 'none';
                });
            });
            
            // Configuraci√≥n global
            state.elements.globalConfigBtn.addEventListener('click', () => state.elements.configModal.showModal());
            
            // Tema
            state.elements.themeSwitcher.addEventListener('change', (e) => {
                document.documentElement.setAttribute('data-theme', e.target.value);
                document.body.classList.toggle('light-theme', 
                    ['light', 'corporate'].includes(e.target.value));
            });
            
            // Efecto de retroiluminaci√≥n
            state.elements.glowEffectToggle.addEventListener('change', (e) => {
                state.glowEffectEnabled = e.target.checked;
                document.body.classList.toggle('glow-effect', state.glowEffectEnabled);
            });
            
            // Auto fullscreen
            state.elements.autoFullscreenToggle.addEventListener('change', (e) => {
                state.autoFullscreen = e.target.checked;
            });
            
            // Cuenta regresiva por defecto
            state.elements.defaultCountdownSelect.addEventListener('change', (e) => {
                state.defaultCountdown = parseInt(e.target.value);
            });
            
            // Intensidad LED
            state.elements.ledIntensity.addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--glow-intensity', `${e.target.value}px`);
            });
            
            // Sonidos
            state.elements.soundToggle.addEventListener('change', (e) => {
                soundManager.setEnabled(e.target.checked);
            });
            
            // Exportar programas
            state.elements.exportProgramsBtn.addEventListener('click', () => {
                customPrograms.exportPrograms();
            });
            
            // Importar programas
            state.elements.importProgramsBtn.addEventListener('click', () => {
                state.elements.importFileInput.click();
            });
            
            state.elements.importFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    customPrograms.importPrograms(e.target.files[0]);
                }
                e.target.value = '';
            });
            
            // Guardar configuraci√≥n
            document.getElementById('save-config').addEventListener('click', () => {
                localStorage.setItem('glowEffect', state.elements.glowEffectToggle.checked);
                localStorage.setItem('ledIntensity', state.elements.ledIntensity.value);
                localStorage.setItem('autoFullscreen', state.elements.autoFullscreenToggle.checked);
                localStorage.setItem('defaultCountdown', state.defaultCountdown);
                localStorage.setItem('soundEnabled', state.elements.soundToggle.checked);
            });
            
            // Modo concentraci√≥n - ahora funciona con todos los programas
            state.elements.fullscreenBtn.addEventListener('click', () => {
                state.isFullscreen = true;
                state.elements.concentrationMode.classList.remove('hidden');
            });
            
            state.elements.concentrationActionBtn.addEventListener('click', () => {
                state.isTimerRunning ? timerLogic.pauseTimer() : timerLogic.startTimer();
            });
            
            state.elements.minimizeBtn.addEventListener('click', () => {
                state.isFullscreen = false;
                state.elements.concentrationMode.classList.add('hidden');
            });
            
            // Crear programa personalizado
            state.elements.customProgramBtn.addEventListener('click', () => {
                if (state.editMode) {
                    state.editingProgram = null;
                    state.elements.modalTitle.textContent = 'Crear programa';
                    state.elements.saveProgramBtn.textContent = 'Guardar';
                    state.elements.createProgramModal.showModal();
                }
            });
            
            // Configuraci√≥n de programas
            const configurablePrograms = ['count-up', 'count-down', 'amrap', 'for-time', 'emom', 'hiit', 'tabata'];
            const modals = {
                'count-up': document.getElementById('config-count-up-modal'),
                'count-down': document.getElementById('config-count-down-modal'),
                'amrap': document.getElementById('config-amrap-modal'),
                'for-time': document.getElementById('config-for-time-modal'),
                'emom': document.getElementById('config-emom-modal'),
                'hiit': document.getElementById('config-hiit-modal'),
                'tabata': document.getElementById('config-tabata-modal')
            };
            
            // Configurar botones de cancelar para los modales
            const cancelButtons = {
                'count-up': document.getElementById('cancel-count-up'),
                'count-down': document.getElementById('cancel-count-down'),
                'amrap': document.getElementById('cancel-amrap'),
                'for-time': document.getElementById('cancel-for-time'),
                'emom': document.getElementById('cancel-emom'),
                'hiit': document.getElementById('cancel-hiit'),
                'tabata': document.getElementById('cancel-tabata')
            };
            
            // Configurar botones de aplicar para los modales
            const applyButtons = {
                'count-up': document.getElementById('apply-count-up'),
                'count-down': document.getElementById('apply-count-down'),
                'amrap': document.getElementById('apply-amrap'),
                'for-time': document.getElementById('apply-for-time'),
                'emom': document.getElementById('apply-emom'),
                'hiit': document.getElementById('apply-hiit'),
                'tabata': document.getElementById('apply-tabata')
            };
            
            // Configurar evento de cancelar para cerrar el modal
            Object.keys(cancelButtons).forEach(program => {
                const cancelButton = cancelButtons[program];
                if (cancelButton) {
                    cancelButton.addEventListener('click', () => {
                        if (modals[program]) {
                            modals[program].close();
                        }
                    });
                }
            });
            
            // Configurar evento de aplicar para guardar la configuraci√≥n
            Object.keys(applyButtons).forEach(program => {
                const applyButton = applyButtons[program];
                if (applyButton) {
                    applyButton.addEventListener('click', () => {
                        switch(program) {
                            case 'count-up':
                                state.programConfig['count-up'].maxTime = utils.timeToSeconds(
                                    document.getElementById('count-up-max').value
                                );
                                break;
                            case 'count-down':
                                state.programConfig['count-down'].initialTime = utils.timeToSeconds(
                                    document.getElementById('count-down-init').value
                                );
                                break;
                            case 'amrap':
                                state.programConfig['amrap'].duration = utils.timeToSeconds(
                                    document.getElementById('amrap-duration').value
                                );
                                break;
                            case 'for-time':
                                state.programConfig['for-time'].maxTime = utils.timeToSeconds(
                                    document.getElementById('for-time-max').value
                                );
                                break;
                            case 'emom':
                                state.programConfig['emom'].totalMinutes = parseInt(document.getElementById('emom-total').value);
                                state.programConfig['emom'].reps = parseInt(document.getElementById('emom-reps').value);
                                break;
                            case 'hiit':
                                state.programConfig['hiit'].warmup = parseInt(document.getElementById('hiit-warmup').value);
                                state.programConfig['hiit'].work = parseInt(document.getElementById('hiit-work').value);
                                state.programConfig['hiit'].rest = parseInt(document.getElementById('hiit-rest').value);
                                state.programConfig['hiit'].rounds = parseInt(document.getElementById('hiit-rounds').value);
                                state.programConfig['hiit'].cooldown = parseInt(document.getElementById('hiit-cooldown').value);
                                state.programConfig['hiit'].direction = 
                                    document.querySelector('input[name="hiit-direction"]:checked').value;
                                break;
                            case 'tabata':
                                state.programConfig['tabata'].rounds = parseInt(document.getElementById('tabata-rounds').value);
                                state.programConfig['tabata'].work = parseInt(document.getElementById('tabata-work').value);
                                state.programConfig['tabata'].rest = parseInt(document.getElementById('tabata-rest').value);
                                break;
                        }
                        programLogic.setProgram(program);
                        if (modals[program]) {
                            modals[program].close();
                        }
                    });
                }
            });
            
            configurablePrograms.forEach(program => {
                document.querySelector(`[data-program="${program}"]`).addEventListener('click', () => {
                    if (state.editMode) {
                        // Configurar y mostrar modal
                        switch(program) {
                            case 'count-up':
                                document.getElementById('count-up-max').value = 
                                    utils.secondsToTime(state.programConfig['count-up'].maxTime);
                                break;
                            case 'count-down':
                                document.getElementById('count-down-init').value = 
                                    utils.secondsToTime(state.programConfig['count-down'].initialTime);
                                break;
                            case 'amrap':
                                document.getElementById('amrap-duration').value = 
                                    utils.secondsToTime(state.programConfig['amrap'].duration);
                                break;
                            case 'for-time':
                                document.getElementById('for-time-max').value = 
                                    utils.secondsToTime(state.programConfig['for-time'].maxTime);
                                break;
                            case 'emom':
                                document.getElementById('emom-total').value = state.programConfig['emom'].totalMinutes;
                                document.getElementById('emom-reps').value = state.programConfig['emom'].reps;
                                break;
                            case 'hiit':
                                document.getElementById('hiit-warmup').value = state.programConfig['hiit'].warmup;
                                document.getElementById('hiit-work').value = state.programConfig['hiit'].work;
                                document.getElementById('hiit-rest').value = state.programConfig['hiit'].rest;
                                document.getElementById('hiit-rounds').value = state.programConfig['hiit'].rounds;
                                document.getElementById('hiit-cooldown').value = state.programConfig['hiit'].cooldown;
                                document.querySelector(`#hiit-${state.programConfig['hiit'].direction}`).checked = true;
                                break;
                            case 'tabata':
                                document.getElementById('tabata-rounds').value = state.programConfig['tabata'].rounds;
                                document.getElementById('tabata-work').value = state.programConfig['tabata'].work;
                                document.getElementById('tabata-rest').value = state.programConfig['tabata'].rest;
                                break;
                        }
                        if (modals[program]) {
                            modals[program].showModal();
                        }
                    } else {
                        programLogic.setProgram(program);
                    }
                });
            });
            
            // Programas sin configuraci√≥n
            ['clock', 'stopwatch'].forEach(program => {
                document.querySelector(`[data-program="${program}"]`).addEventListener('click', () => {
                    if (!state.editMode) programLogic.setProgram(program);
                });
            });
            
            // Soporte para teclado
            document.addEventListener('keydown', (e) => {
                // Espacio para play/pausa
                if (e.key === ' ' && state.activeProgram !== 'clock') {
                    e.preventDefault();
                    state.isTimerRunning ? timerLogic.pauseTimer() : timerLogic.startTimer();
                }
                
                // Esc para salir del modo concentraci√≥n
                if (e.key === 'Escape' && state.isFullscreen) {
                    state.isFullscreen = false;
                    state.elements.concentrationMode.classList.add('hidden');
                }
                
                // Tecla R para reset
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    timerLogic.resetTimer();
                }
                
                // Tecla E para entrar/salir del modo edici√≥n
                if ((e.key === 'e' || e.key === 'E') && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    state.elements.editCorner.click();
                }
            });
        }

        // Inicializaci√≥n de la aplicaci√≥n
        function initApp() {
            initElements();
            setupEventListeners();
            initProgramCreationModal();
            customPrograms.loadCustomPrograms();
            programLogic.setProgram('clock');
            
            // Actualizar reloj cada segundo
            setInterval(() => {
                if (state.activeProgram === 'clock') {
                    timerLogic.updateClock();
                }
            }, 1000);
            
            // Cargar configuraci√≥n guardada
            const savedGlow = localStorage.getItem('glowEffect');
            if (savedGlow !== null) {
                state.glowEffectEnabled = savedGlow === 'true';
                state.elements.glowEffectToggle.checked = state.glowEffectEnabled;
                document.body.classList.toggle('glow-effect', state.glowEffectEnabled);
            }
            
            const savedIntensity = localStorage.getItem('ledIntensity');
            if (savedIntensity !== null) {
                state.elements.ledIntensity.value = savedIntensity;
                document.documentElement.style.setProperty('--glow-intensity', `${savedIntensity}px`);
            }
            
            const savedAutoFullscreen = localStorage.getItem('autoFullscreen');
            if (savedAutoFullscreen !== null) {
                state.autoFullscreen = savedAutoFullscreen === 'true';
                state.elements.autoFullscreenToggle.checked = state.autoFullscreen;
            }
            
            const savedDefaultCountdown = localStorage.getItem('defaultCountdown');
            if (savedDefaultCountdown !== null) {
                state.defaultCountdown = parseInt(savedDefaultCountdown);
                if (state.elements.defaultCountdownSelect) {
                    state.elements.defaultCountdownSelect.value = state.defaultCountdown;
                }
            }
            
            const savedSoundEnabled = localStorage.getItem('soundEnabled');
            if (savedSoundEnabled !== null) {
                const isEnabled = savedSoundEnabled === 'true';
                state.elements.soundToggle.checked = isEnabled;
                soundManager.setEnabled(isEnabled);
            } else {
                state.elements.soundToggle.checked = true;
                soundManager.setEnabled(true);
            }
        }

        // Iniciar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
