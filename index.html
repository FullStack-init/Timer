<!DOCTYPE html>
<html lang="es" class="h-full bg-base-200 text-base-content">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fitness Timer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.7.0/dist/full.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script>
        tailwind.config = {
            darkMode: "class",
            plugins: [require("daisyui")],
            daisyui: {
                themes: ["luxury", "cyberpunk", "forest", "lofi", "corporate", "light", "abyss", "synthwave", "black", "dark"],
                darkTheme: "luxury"
            }
        };
    </script>
    <style>
        :root {
            --led-on: #00fffc;
            --led-off: rgba(0, 100, 100, 0.1);
            --glow-intensity: 10px;
        }
        .light-theme {
            --led-on: #00a8a8;
            --led-off: rgba(0, 0, 0, 0.05);
        }
        .segment {
            position: absolute;
            background: var(--led-off);
            border-radius: 3px;
            transition: all 0.1s;
        }
        .segment.on {
            background: var(--led-on);
            box-shadow: 0 0 var(--glow-intensity) var(--led-on);
        }
        .glow-effect .segment.on {
            box-shadow: 0 0 15px 5px var(--led-on);
        }
        .segment-a { width: 40px; height: 8px; top: 0; left: 10px; }
        .segment-b { width: 8px; height: 40px; top: 8px; right: 0; }
        .segment-c { width: 8px; height: 40px; bottom: 8px; right: 0; }
        .segment-d { width: 40px; height: 8px; bottom: 0; left: 10px; }
        .segment-e { width: 8px; height: 40px; bottom: 8px; left: 0; }
        .segment-f { width: 8px; height: 40px; top: 8px; left: 0; }
        .segment-g { width: 40px; height: 8px; top: 50%; left: 10px; transform: translateY(-50%); }
        .colon {
            width: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            height: 100%;
        }
        .colon-dot {
            width: 8px;
            height: 8px;
            background: var(--led-on);
            border-radius: 50%;
            margin: 15px 0;
            opacity: 0.7;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 252, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 252, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 252, 0); }
        }
        .edit-mode .program-btn {
            animation: pulse 2s infinite;
        }
        .edit-mode .program-btn:hover {
            animation: shake 0.5s ease infinite;
            transform: translateY(0);
        }
        .concentration-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .concentration-display {
            transform: scale(1.5);
            margin-bottom: 3rem;
        }
        .concentration-controls {
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        .concentration-controls:hover {
            opacity: 1;
        }
        .display-container {
            background: rgba(15, 15, 25, 0.9);
            border-radius: 16px;
            padding: 15px 25px;
            box-shadow: 
                0 0 25px rgba(0, 0, 0, 0.6),
                inset 0 0 10px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(80, 80, 100, 0.3);
            aspect-ratio: 16/6;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .digits {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: relative;
            padding: 5px 0;
        }
        .digit-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            padding: 0 5px;
        }
        .digit {
            position: relative;
            width: 60px; 
            height: 100px;
            margin: 0 3px;
            flex-shrink: 0;
        }
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 150, 150, 0.3);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--led-on);
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .fullscreen-btn:hover {
            opacity: 1;
        }
        .custom-program-card {
            position: relative;
        }
        .delete-custom {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff0000;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        .edit-mode .custom-program-card .delete-custom {
            display: flex;
        }
        .program-btn.active {
            background: #3b82f6 !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .program-btn.running {
            animation: pulse 1.5s infinite;
        }
        .program-info {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        /* Corrección del botón minimizar en modo concentración */
        .minimize-btn-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
        }
        
        /* Botones de control */
        .control-buttons {
            display: flex;
            gap: 1rem;
            width: 100%;
        }
        
        .control-button {
            flex: 1;
            height: 3.5rem;
        }
        
        /* Responsive improvements for mobile */
        @media (max-width: 768px) {
            .display-container {
                padding: 10px 15px;
                border-radius: 12px;
            }
            
            .digit {
                width: 45px;
                height: 75px;
            }
            
            .segment-a { width: 30px; height: 6px; left: 7px; }
            .segment-b { width: 6px; height: 30px; top: 6px; }
            .segment-c { width: 6px; height: 30px; bottom: 6px; }
            .segment-d { width: 30px; height: 6px; left: 7px; }
            .segment-e { width: 6px; height: 30px; bottom: 6px; }
            .segment-f { width: 6px; height: 30px; top: 6px; }
            .segment-g { width: 30px; height: 6px; left: 7px; }
            
            .colon {
                width: 12px;
            }
            
            .colon-dot {
                width: 6px;
                height: 6px;
                margin: 12px 0;
            }
            
            .fullscreen-btn {
                width: 25px;
                height: 25px;
            }
            
            .control-button {
                height: 3rem;
                font-size: 0.875rem;
            }
        }
        
        @media (max-width: 480px) {
            .display-container {
                padding: 8px 12px;
                border-radius: 10px;
            }
            
            .digit {
                width: 35px;
                height: 55px;
            }
            
            .segment-a { width: 22px; height: 4px; left: 5px; }
            .segment-b { width: 4px; height: 22px; top: 4px; }
            .segment-c { width: 4px; height: 22px; bottom: 4px; }
            .segment-d { width: 22px; height: 4px; left: 5px; }
            .segment-e { width: 4px; height: 22px; bottom: 4px; }
            .segment-f { width: 4px; height: 22px; top: 4px; }
            .segment-g { width: 22px; height: 4px; left: 5px; }
            
            .colon {
                width: 10px;
            }
            
            .colon-dot {
                width: 4px;
                height: 4px;
                margin: 8px 0;
            }
            
            .fullscreen-btn {
                width: 20px;
                height: 20px;
            }
            
            .concentration-display {
                transform: scale(1.2);
            }
            
            .control-button {
                height: 2.5rem;
                font-size: 0.75rem;
            }
        }
        
        /* Countdown overlay */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        
        .countdown-number {
            font-size: 10rem;
            color: var(--led-on);
            text-shadow: 0 0 15px var(--led-on);
            font-weight: bold;
        }
        
        .countdown-text {
            font-size: 2rem;
            color: white;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="h-full flex flex-col glow-effect">
    <!-- Navbar -->
    <nav class="navbar bg-base-300 px-4 py-3 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div class="app-name text-xl font-bold text-primary flex items-center gap-2">
            <i class="fas fa-dumbbell"></i>
            FITNESS TIMER PRO
        </div>
        <div class="nav-actions flex items-center gap-3">
            <button id="global-config-btn" class="btn btn-ghost btn-circle" title="Configuración global">
                <i class="fas fa-cog"></i>
            </button>
            <div class="wifi-status badge badge-outline badge-primary gap-2">
                <i class="fas fa-wifi"></i>
                <span>Conectado</span>
            </div>
        </div>
    </nav>
    <!-- Contenido principal -->
    <main class="container mx-auto p-4 max-w-lg flex-1 flex flex-col">
        <!-- Display principal optimizado -->
        <div class="display-container relative">
            <button class="fullscreen-btn" id="fullscreen-btn">
                <i class="fas fa-expand"></i>
            </button>
            <div class="digits" id="display"></div>
        </div>
        <!-- Botones de acción principal -->
        <div class="control-buttons mt-4">
            <button id="action-btn" class="btn btn-primary btn-lg control-button">Iniciar</button>
            <button id="reset-btn" class="btn btn-secondary btn-lg control-button">Reset</button>
        </div>
        <!-- Programas de entrenamiento -->
        <div class="programs-section bg-base-100 rounded-2xl p-4 shadow-lg border border-base-300 relative mt-4">
            <div class="edit-corner absolute top-0 right-0 w-10 h-10 flex items-center justify-center bg-primary text-primary-content rounded-bl-2xl cursor-pointer" id="edit-corner">
                <i class="fas fa-pencil-alt"></i>
            </div>
            <div class="section-header mb-4">
                <h2 class="section-title text-lg font-semibold text-center">
                    Programas de Entrenamiento
                </h2>
            </div>
            <div class="programs grid grid-cols-3 gap-3" id="programs-container">
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="clock">
                    <div class="btn-text">Reloj</div>
                    <div class="program-info">Hora actual</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="stopwatch">
                    <div class="btn-text">Cronómetro</div>
                    <div class="program-info">Cuenta ascendente</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="count-up">
                    <div class="btn-text">Contador Asc.</div>
                    <div class="program-info">Hasta límite</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="count-down">
                    <div class="btn-text">Contador Desc.</div>
                    <div class="program-info">Desde inicial</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="amrap">
                    <div class="btn-text">AMRAP</div>
                    <div class="program-info">Tantas rondas</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="tabata">
                    <div class="btn-text">TABATA</div>
                    <div class="program-info">20s trabajo/10s desc</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="emom">
                    <div class="btn-text">EMOM</div>
                    <div class="program-info">Cada minuto</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="hiit">
                    <div class="btn-text">HIIT</div>
                    <div class="program-info">Entrenamiento intenso</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="for-time">
                    <div class="btn-text">For Time</div>
                    <div class="program-info">Tiempo total</div>
                </div>
                <div class="program-btn custom hidden aspect-square bg-base-200 border-2 border-dashed border-primary rounded-xl p-3 text-center cursor-pointer transition-all" data-program="custom">
                    <div class="custom-program-text text-primary font-semibold text-sm">
                        <i class="fas fa-plus-circle"></i>
                        Crear programa
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-300 text-base-content">
        <aside>
            <p>Conectado a dispositivo físico • Versión 2.5</p>
        </aside>
    </footer>
    <!-- Modales -->
    <!-- Modal de configuración global -->
    <dialog id="config-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configuración Global</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tema de color</span>
                    </label>
                    <select id="themeSwitcher" class="select select-bordered">
                        <option value="luxury">Luxury</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="forest">Forest</option>
                        <option value="lofi">Lofi</option>
                        <option value="corporate">Corporate</option>
                        <option value="light">Light</option>
                        <option value="abyss">Abyss</option>
                        <option value="synthwave">Synthwave</option>
                        <option value="black">Black</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Sonidos</span> 
                        <input type="checkbox" class="toggle toggle-primary" checked />
                    </label>
                </div>
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Efecto retroiluminación</span> 
                        <input type="checkbox" id="glow-effect-toggle" class="toggle toggle-primary" checked />
                    </label>
                </div>
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Maximización automática</span> 
                        <input type="checkbox" id="auto-fullscreen-toggle" class="toggle toggle-primary" checked />
                    </label>
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Cuenta regresiva por defecto</span>
                    </label>
                    <select id="default-countdown" class="select select-bordered">
                        <option value="0">0 segundos</option>
                        <option value="3">3 segundos</option>
                        <option value="5">5 segundos</option>
                        <option value="10">10 segundos</option>
                        <option value="15">15 segundos</option>
                        <option value="20">20 segundos</option>
                        <option value="30">30 segundos</option>
                        <option value="45">45 segundos</option>
                        <option value="60">60 segundos</option>
                    </select>
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Intensidad de LEDs</span>
                    </label>
                    <input type="range" min="1" max="10" value="8" class="range range-primary" id="led-intensity" />
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-ghost">Cancelar</button>
                    <button class="btn btn-primary" id="save-config">Guardar</button>
                </form>
            </div>
        </div>
    </dialog>
    <!-- Modal de creación de programas -->
    <dialog id="create-program-modal" class="modal">
        <div class="modal-box max-w-md w-full">
            <form method="dialog" id="programForm">
                <header class="flex justify-between items-center pb-2">
                    <h3 class="font-bold text-lg">Crear programa</h3>
                    <button type="button" class="btn btn-circle btn-ghost btn-sm" id="closeDialogBtn">
                        ×
                    </button>
                </header>
                <div class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <input
                            type="text"
                            id="program-name"
                            placeholder="Nombre del programa"
                            required
                            class="input input-bordered input-sm w-full text-sm"
                        />
                        <select
                            id="countdown"
                            class="select select-bordered select-sm w-full text-sm"
                        >
                            <option value="0">Sin cuenta regresiva</option>
                            <option value="3">3 segundos</option>
                            <option value="5">5 segundos</option>
                            <option value="10">10 segundos</option>
                            <option value="15">15 segundos</option>
                            <option value="20">20 segundos</option>
                            <option value="30">30 segundos</option>
                        </select>
                    </div>
                    <textarea
                        id="program-description"
                        placeholder="Descripción del programa (opcional)"
                        class="textarea textarea-bordered textarea-sm w-full text-sm"
                    ></textarea>
                </div>
                <div class="mt-3">
                    <h4 class="mb-2 font-semibold text-sm">Bloques de tiempo:</h4>
                    <div
                        id="blockList"
                        class="block-list-container border border-dashed border-transparent"
                    ></div>
                </div>
                <div class="mt-3 flex gap-2 justify-center">
                    <button
                        type="button"
                        id="addMainBlockBtn"
                        class="btn btn-outline btn-sm w-full"
                    >
                        + Añadir Bloque
                    </button>
                </div>
                <div class="modal-action mt-3">
                    <button
                        type="button"
                        id="cancelCreate"
                        class="btn btn-ghost btn-sm"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </dialog>
    <!-- Modales de configuración de programas -->
    <!-- Modal Contador Ascendente -->
    <dialog id="config-count-up-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Contador Ascendente</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tiempo máximo (mm:ss)</span>
                    </label>
                    <input type="text" id="count-up-max" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es el Contador Ascendente?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">El contador ascendente comienza en 00:00 y cuenta hacia arriba hasta el tiempo máximo que configures. Es útil para medir cuánto tiempo llevas en una actividad.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-count-up">Cancelar</button>
                <button class="btn btn-primary" id="apply-count-up">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal Contador Descendente -->
    <dialog id="config-count-down-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Contador Descendente</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tiempo inicial (mm:ss)</span>
                    </label>
                    <input type="text" id="count-down-init" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es el Contador Descendente?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">Comienza en el tiempo configurado y cuenta hacia abajo hasta 00:00. Ideal para ejercicios con tiempo límite.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-count-down">Cancelar</button>
                <button class="btn btn-primary" id="apply-count-down">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal AMRAP -->
    <dialog id="config-amrap-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar AMRAP</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Duración (mm:ss)</span>
                    </label>
                    <input type="text" id="amrap-duration" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es AMRAP?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">AMRAP (As Many Rounds As Possible): Completa tantas rondas como sea posible de un circuito en el tiempo establecido. El tiempo corre en cuenta regresiva.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-amrap">Cancelar</button>
                <button class="btn btn-primary" id="apply-amrap">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal EMOM -->
    <dialog id="config-emom-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar EMOM</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Duración total (minutos)</span>
                    </label>
                    <input type="number" id="emom-total" class="input input-bordered" min="1" max="60" value="10">
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Repeticiones por minuto</span>
                    </label>
                    <input type="number" id="emom-reps" class="input input-bordered" min="1" max="20" value="10">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es EMOM?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">EMOM (Every Minute On the Minute): Realiza los ejercicios al inicio de cada minuto. El tiempo restante del minuto es para descanso. El contador es descendente.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-emom">Cancelar</button>
                <button class="btn btn-primary" id="apply-emom">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal HIIT -->
    <dialog id="config-hiit-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar HIIT</h3>
            <div class="py-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Calentamiento</span>
                        </label>
                        <select id="hiit-warmup" class="select select-bordered">
                            <option value="0">0 min</option>
                            <option value="3">3 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="7">7 min</option>
                            <option value="10">10 min</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trabajo intenso</span>
                        </label>
                        <select id="hiit-work" class="select select-bordered">
                            <option value="20" selected>20 s</option>
                            <option value="30">30 s</option>
                            <option value="40">40 s</option>
                            <option value="45">45 s</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Descanso</span>
                        </label>
                        <select id="hiit-rest" class="select select-bordered">
                            <option value="10" selected>10 s</option>
                            <option value="15">15 s</option>
                            <option value="20">20 s</option>
                            <option value="30">30 s</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Repeticiones</span>
                        </label>
                        <select id="hiit-rounds" class="select select-bordered">
                            <option value="4">4</option>
                            <option value="6">6</option>
                            <option value="8" selected>8</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Enfriamiento</span>
                        </label>
                        <select id="hiit-cooldown" class="select select-bordered">
                            <option value="0">0 min</option>
                            <option value="3">3 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="7">7 min</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Dirección</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="radio" name="hiit-direction" id="hiit-down" value="down" class="radio radio-primary" checked>
                            <label for="hiit-down">Descendente</label>
                            <input type="radio" name="hiit-direction" id="hiit-up" value="up" class="radio radio-primary">
                            <label for="hiit-up">Ascendente</label>
                        </div>
                    </div>
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es HIIT?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">HIIT (High Intensity Interval Training): Alterna períodos de ejercicio intenso con descanso. Este temporizador maneja calentamiento, ciclos de trabajo/descanso y enfriamiento.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-hiit">Cancelar</button>
                <button class="btn btn-primary" id="apply-hiit">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modal TABATA -->
    <dialog id="config-tabata-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar TABATA</h3>
            <div class="py-4">
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Rondas</span>
                        </label>
                        <input type="number" id="tabata-rounds" class="input input-bordered" min="1" max="20" value="8">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trabajo (s)</span>
                        </label>
                        <input type="number" id="tabata-work" class="input input-bordered" min="5" max="60" value="20">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Descanso (s)</span>
                        </label>
                        <input type="number" id="tabata-rest" class="input input-bordered" min="5" max="60" value="10">
                    </div>
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es TABATA?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">Protocolo de 20 segundos de trabajo intenso seguidos de 10 segundos de descanso, repetido por 8 rondas (4 minutos totales). Puedes personalizar estos valores.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-tabata">Cancelar</button>
                <button class="btn btn-primary" id="apply-tabata">Aplicar</button>
            </div>
        </div>
    </dialog>
    <!-- Modo concentración -->
    <div class="concentration-mode hidden" id="concentration-mode">
        <div class="minimize-btn-container">
            <button class="btn btn-ghost text-white" id="minimize-btn">
                <i class="fas fa-compress"></i>
            </button>
        </div>
        <div class="concentration-display" id="concentration-display"></div>
        <div class="concentration-controls flex gap-4 mt-4">
            <button class="btn btn-primary btn-circle" id="concentration-action-btn">
                <i class="fas fa-play"></i>
            </button>
            <button class="btn btn-secondary btn-circle" id="concentration-reset-btn">
                <i class="fas fa-undo"></i>
            </button>
        </div>
    </div>
    <!-- Overlay de cuenta regresiva -->
    <div class="countdown-overlay" id="countdown-overlay">
        <div class="countdown-number" id="countdown-number">3</div>
        <div class="countdown-text" id="countdown-text">¡Listo para empezar!</div>
    </div>
    <!-- Plantillas para bloques -->
    <template id="main-block-template">
      <article
        class="card mb-2 shadow hover:shadow-lg transition-all duration-200 bg-base-300 border border-base-content/20 main-block"
      >
        <div class="card-body p-2 relative">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-grow">
              <button
                type="button"
                class="btn btn-xs btn-ghost mr-1"
                data-action="toggle-content"
              >
                ▼
              </button>
              <h3
                class="font-bold text-base flex-grow cursor-pointer"
                data-action="edit-title"
              >
                Bloque
              </h3>
            </div>
            <button
              type="button"
              class="btn btn-xs btn-ghost ml-auto"
              aria-label="Eliminar bloque"
              data-action="delete-block"
            >
              ×
            </button>
          </div>
          <div
            class="content hidden mt-2 pt-2 border-t border-base-content/10 flex flex-col gap-2"
          >
            <div class="flex items-center">
              <select
                class="select select-sm select-bordered w-full"
                data-field="repeat"
              ></select>
            </div>
            <h5 class="text-xs font-semibold">Sub Bloques de tiempo:</h5>
            <div
              class="sub-block-list-container block-list-container border border-dashed border-transparent rounded"
            ></div>
            <button
              type="button"
              class="btn btn-outline btn-xs w-full"
              data-action="add-sub-block"
            >
              + Añadir Sub Bloque
            </button>
          </div>
        </div>
      </article>
    </template>
    <template id="sub-block-template">
      <article
        class="card mb-1 shadow hover:shadow-lg transition-all duration-200 bg-base-100 border border-base-content/10 block-item"
      >
        <div class="card-body p-1 pt-2 relative">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-grow">
              <button
                type="button"
                class="btn btn-xs btn-ghost mr-1"
                data-action="toggle-content"
              >
                ▼
              </button>
              <h3
                class="text-sm font-medium flex-grow cursor-pointer"
                data-action="edit-title"
              >
                Sub Bloque
              </h3>
            </div>
            <button
              type="button"
              class="btn btn-xs btn-ghost ml-auto"
              aria-label="Eliminar bloque"
              data-action="delete-block"
            >
              ×
            </button>
          </div>
          <div class="content hidden mt-1 pt-1 border-t border-base-content/10">
            <div class="flex flex-col gap-1">
              <div
                class="flex flex-wrap justify-evenly items-center gap-1 w-full min-w-0"
              >
                <div class="flex justify-center min-w-0 w-16">
                  <input
                    type="text"
                    placeholder="Tiempo"
                    class="input input-xs input-bordered min-w-[3rem] max-w-[4.5rem] text-center text-xs"
                    data-field="time"
                  />
                </div>
                <div class="flex justify-center min-w-0 w-16">
                  <input
                    type="text"
                    placeholder="Aviso"
                    class="input input-xs input-bordered min-w-[3rem] max-w-[4.5rem] text-center text-xs"
                    data-field="warning"
                  />
                </div>
                <div class="relative flex justify-center min-w-0">
                  <div class="absolute -top-3.5 left-10 z-20 tooltip tooltip-left tooltip-info tooltip-click" 
                       data-tip="Elige la dirección del tiempo: ascendente (sube) o descendente (baja).">
                    <button type="button" 
                            class="btn p-0 min-h-[0.85rem] h-[0.85rem] w-[0.85rem] 
                                   border border-base-content/20 bg-base-200 text-base-content/70 
                                   rounded-full hover:bg-base-300 hover:text-base-content 
                                   transition-all duration-150">
                      <i class="fas fa-info text-[0.55rem]"></i>
                    </button>
                  </div>
                  <div class="flex rounded-full border border-base-content/10 bg-base-100">
                    <button
                      type="button"
                      class="btn btn-ghost btn-xs text-base px-1 py-0.5 rounded-l-full !rounded-r-none"
                      data-action="set-direction"
                      data-value="up"
                    >
                      <i class="fas fa-arrow-up text-xs"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-ghost btn-xs text-base px-1 py-0.5 rounded-r-full !rounded-l-none"
                      data-action="set-direction"
                      data-value="down"
                    >
                      <i class="fas fa-arrow-down text-xs"></i>
                    </button>
                    <input type="hidden" data-field="direction" value="up" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </article>
    </template>
    <script>
        // Clase para manejar el display de 7 segmentos
        class SevenSegmentDisplay {
            constructor(containerId, isConcentrationMode = false) {
                this.container = document.getElementById(containerId);
                this.isConcentrationMode = isConcentrationMode;
                this.digitMap = [
                    ['a', 'b', 'c', 'd', 'e', 'f'],     // 0
                    ['b', 'c'],                          // 1
                    ['a', 'b', 'g', 'e', 'd'],          // 2
                    ['a', 'b', 'g', 'c', 'd'],          // 3
                    ['f', 'g', 'b', 'c'],               // 4
                    ['a', 'f', 'g', 'c', 'd'],          // 5
                    ['a', 'f', 'g', 'c', 'd', 'e'],     // 6
                    ['a', 'b', 'c'],                    // 7
                    ['a', 'b', 'c', 'd', 'e', 'f', 'g'],// 8
                    ['a', 'b', 'c', 'd', 'f', 'g']      // 9
                ];
                this.initDisplay();
            }
            
            initDisplay() {
                this.container.innerHTML = '';
                const digitContainer = document.createElement('div');
                digitContainer.className = 'digit-container flex';
                
                // Crear dígitos y dos puntos en formato HH:MM:SS o MM:SS:CC
                for (let i = 0; i < 8; i++) {
                    if (i === 2 || i === 5) {
                        const colon = document.createElement('div');
                        colon.className = 'colon';
                        colon.innerHTML = '<div class="colon-dot"></div><div class="colon-dot"></div>';
                        digitContainer.appendChild(colon);
                    } else {
                        digitContainer.appendChild(this.createDigit());
                    }
                }
                
                this.container.appendChild(digitContainer);
                return this.container;
            }
            
            createDigit() {
                const digit = document.createElement('div');
                digit.className = 'digit relative';
                ['a', 'b', 'c', 'd', 'e', 'f', 'g'].forEach(seg => {
                    const segment = document.createElement('div');
                    segment.className = `segment segment-${seg}`;
                    digit.appendChild(segment);
                });
                return digit;
            }
            
            updateDigit(digit, num) {
                const segments = digit.querySelectorAll('.segment');
                segments.forEach(s => s.classList.remove('on'));
                if (num === ' ') return;
                this.digitMap[num].forEach(s => {
                    digit.querySelector(`.segment-${s}`).classList.add('on');
                });
            }
            
            updateDisplay(timeStr) {
                const digits = this.container.querySelectorAll('.digit');
                const timeChars = timeStr.replace(/:/g, '').split('');
                
                for (let i = 0; i < digits.length; i++) {
                    if (timeChars[i] === ' ') {
                        this.updateDigit(digits[i], ' ');
                    } else {
                        this.updateDigit(digits[i], parseInt(timeChars[i]));
                    }
                }
                
                // Parpadeo de los dos puntos
                const colons = this.container.querySelectorAll('.colon-dot');
                const now = new Date();
                const visible = this.isConcentrationMode ? 
                    (state.isTimerRunning && state.timerValue % 2 === 0) :
                    (state.activeProgram === 'clock' ? (now.getSeconds() % 2 === 0) : (state.isTimerRunning && state.timerValue % 2 === 0));
                
                colons.forEach(dot => dot.style.opacity = visible ? '0.8' : '0.3');
            }
        }

        // Estado de la aplicación
        const state = {
            activeProgram: 'clock',
            timerValue: 0,
            isTimerRunning: false,
            timerInterval: null,
            countDirection: 'down',
            isConnected: false,
            editMode: false,
            stopwatchCentiseconds: 0,
            stopwatchInterval: null,
            isFullscreen: false,
            glowEffectEnabled: true,
            autoFullscreen: true,
            defaultCountdown: 3,
            countdownActive: false,
            countdownInterval: null,
            countdownValue: 0,
            programConfig: {
                'count-up': { maxTime: 300 },
                'count-down': { initialTime: 300 },
                'amrap': { duration: 300 },
                'emom': { totalMinutes: 10, reps: 10 },
                'hiit': { 
                    warmup: 5,
                    work: 20,
                    rest: 10,
                    rounds: 8,
                    cooldown: 5,
                    direction: 'down'
                },
                'tabata': { rounds: 8, work: 20, rest: 10 },
                'for-time': { maxTime: 600 }
            },
            customPrograms: [],
            elements: {
                display: null,
                concentrationDisplay: null,
                actionBtn: null,
                resetBtn: null,
                concentrationActionBtn: null,
                concentrationResetBtn: null,
                programBtns: null,
                globalConfigBtn: null,
                editCorner: null,
                configModal: null,
                createProgramModal: null,
                themeSwitcher: null,
                customProgramBtn: null,
                fullscreenBtn: null,
                concentrationMode: null,
                minimizeBtn: null,
                programsContainer: null,
                glowEffectToggle: null,
                ledIntensity: null,
                autoFullscreenToggle: null,
                defaultCountdownSelect: null,
                countdownOverlay: null,
                countdownNumber: null,
                countdownText: null
            }
        };

        // Inicializar elementos
        function initElements() {
            const els = state.elements;
            els.display = new SevenSegmentDisplay('display');
            els.concentrationDisplay = new SevenSegmentDisplay('concentration-display', true);
            els.actionBtn = document.getElementById('action-btn');
            els.resetBtn = document.getElementById('reset-btn');
            els.concentrationActionBtn = document.getElementById('concentration-action-btn');
            els.concentrationResetBtn = document.getElementById('concentration-reset-btn');
            els.programBtns = document.querySelectorAll('.program-btn');
            els.globalConfigBtn = document.getElementById('global-config-btn');
            els.editCorner = document.getElementById('edit-corner');
            els.configModal = document.getElementById('config-modal');
            els.createProgramModal = document.getElementById('create-program-modal');
            els.themeSwitcher = document.getElementById('themeSwitcher');
            els.customProgramBtn = document.querySelector('.program-btn.custom');
            els.fullscreenBtn = document.getElementById('fullscreen-btn');
            els.concentrationMode = document.getElementById('concentration-mode');
            els.minimizeBtn = document.getElementById('minimize-btn');
            els.programsContainer = document.getElementById('programs-container');
            els.glowEffectToggle = document.getElementById('glow-effect-toggle');
            els.ledIntensity = document.getElementById('led-intensity');
            els.autoFullscreenToggle = document.getElementById('auto-fullscreen-toggle');
            els.defaultCountdownSelect = document.getElementById('default-countdown');
            els.countdownOverlay = document.getElementById('countdown-overlay');
            els.countdownNumber = document.getElementById('countdown-number');
            els.countdownText = document.getElementById('countdown-text');
        }

        // Funciones de utilidad
        const utils = {
            timeToSeconds(timeStr) {
                const [mins, secs] = timeStr.split(':').map(Number);
                return (mins * 60) + secs;
            },
            
            secondsToTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            },
            
            formatTimeInput(input) {
                let v = input.value.replace(/\D/g, "").substring(0, 4);
                if (v.length > 2) v = v.substring(0, 2) + ":" + v.substring(2);
                input.value = v;
            },
            
            formatStopwatchTime(centiseconds) {
                const minutes = Math.floor(centiseconds / 6000);
                const remaining = centiseconds % 6000;
                const seconds = Math.floor(remaining / 100);
                const cents = remaining % 100;
                
                return `  ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(cents).padStart(2, '0')}`;
            }
        };

        // Lógica de cuenta regresiva
        const countdownLogic = {
            startCountdown(duration, callback) {
                state.countdownValue = duration;
                state.countdownActive = true;
                state.elements.countdownNumber.textContent = duration;
                state.elements.countdownText.textContent = '¡Listo para empezar!';
                state.elements.countdownOverlay.style.display = 'flex';
                
                state.countdownInterval = setInterval(() => {
                    state.countdownValue--;
                    
                    if (state.countdownValue > 0) {
                        state.elements.countdownNumber.textContent = state.countdownValue;
                    } else {
                        clearInterval(state.countdownInterval);
                        state.elements.countdownOverlay.style.display = 'none';
                        state.countdownActive = false;
                        callback();
                    }
                }, 1000);
            },
            
            cancelCountdown() {
                if (state.countdownActive) {
                    clearInterval(state.countdownInterval);
                    state.elements.countdownOverlay.style.display = 'none';
                    state.countdownActive = false;
                }
            }
        };

        // Lógica del temporizador
        const timerLogic = {
            updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                state.elements.display.updateDisplay(`${hours}:${minutes}:${seconds}`);
                state.elements.concentrationDisplay.updateDisplay(`${hours}:${minutes}:${seconds}`);
            },
            
            updateStopwatch() {
                state.elements.display.updateDisplay(utils.formatStopwatchTime(state.stopwatchCentiseconds));
                state.elements.concentrationDisplay.updateDisplay(utils.formatStopwatchTime(state.stopwatchCentiseconds));
            },
            
            updateTimerDisplay() {
                if (state.activeProgram === 'clock') return;
                
                if (state.activeProgram === 'stopwatch') {
                    this.updateStopwatch();
                    return;
                }
                
                const mins = Math.floor(state.timerValue / 60);
                const secs = state.timerValue % 60;
                const timeStr = `  ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}:00`;
                
                state.elements.display.updateDisplay(timeStr);
                state.elements.concentrationDisplay.updateDisplay(timeStr);
            },
            
            startTimer() {
                if (state.isTimerRunning) return;
                
                // Verificar si se necesita una cuenta regresiva
                let countdownDuration = 0;
                const currentProgram = state.activeProgram;
                
                if (currentProgram === 'clock') {
                    // No se aplica cuenta regresiva al reloj
                    this._startTimerInternal();
                    return;
                }
                
                // Buscar en programas personalizados
                if (currentProgram.startsWith('custom-')) {
                    const customId = currentProgram.split('-')[1];
                    const customProgram = state.customPrograms.find(p => p.id === customId);
                    if (customProgram && customProgram.countdown && customProgram.countdown > 0) {
                        countdownDuration = parseInt(customProgram.countdown);
                    }
                } 
                // Para programas predefinidos
                else if (state.programConfig[currentProgram] && 
                         state.programConfig[currentProgram].hasOwnProperty('countdown') && 
                         state.programConfig[currentProgram].countdown > 0) {
                    countdownDuration = state.programConfig[currentProgram].countdown;
                }
                // Si no tiene cuenta regresiva propia, usar la por defecto
                else {
                    countdownDuration = state.defaultCountdown;
                }
                
                // Iniciar cuenta regresiva si es necesario
                if (countdownDuration > 0) {
                    countdownLogic.startCountdown(countdownDuration, () => {
                        this._startTimerInternal();
                    });
                } else {
                    this._startTimerInternal();
                }
            },
            
            _startTimerInternal() {
                state.isTimerRunning = true;
                state.elements.actionBtn.textContent = 'Pausar';
                state.elements.concentrationActionBtn.innerHTML = '<i class="fas fa-pause"></i>';
                
                // Activar modo concentración para programas de temporizador
                if (state.autoFullscreen && state.activeProgram !== 'clock') {
                    state.isFullscreen = true;
                    state.elements.concentrationMode.classList.remove('hidden');
                }
                
                // Deshabilitar otros programas
                state.elements.programBtns.forEach(btn => {
                    if (btn.dataset.program !== state.activeProgram) {
                        btn.style.pointerEvents = 'none';
                        btn.style.opacity = '0.6';
                    } else {
                        btn.classList.add('running');
                    }
                });
                
                if (state.activeProgram === 'stopwatch') {
                    state.stopwatchCentiseconds = 0;
                    state.stopwatchInterval = setInterval(() => {
                        state.stopwatchCentiseconds++;
                        this.updateStopwatch();
                    }, 10); // Intervalo de 10ms para centésimas
                } else {
                    state.timerInterval = setInterval(() => {
                        if (state.countDirection === 'down') {
                            if (state.timerValue <= 0) {
                                this.pauseTimer();
                                return;
                            }
                            state.timerValue--;
                        } else {
                            state.timerValue++;
                        }
                        this.updateTimerDisplay();
                    }, 1000);
                }
            },
            
            pauseTimer() {
                if (state.activeProgram === 'stopwatch') {
                    clearInterval(state.stopwatchInterval);
                } else {
                    clearInterval(state.timerInterval);
                }
                
                state.isTimerRunning = false;
                state.elements.actionBtn.textContent = 'Iniciar';
                state.elements.concentrationActionBtn.innerHTML = '<i class="fas fa-play"></i>';
                
                // Habilitar programas
                state.elements.programBtns.forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '1';
                    btn.classList.remove('running');
                });
            },
            
            resetTimer() {
                if (state.isTimerRunning) {
                    this.pauseTimer();
                }
                
                // Resetear según el programa activo
                switch(state.activeProgram) {
                    case 'clock':
                        // El reloj no se resetea, solo actualizamos
                        this.updateClock();
                        break;
                    case 'stopwatch':
                        state.stopwatchCentiseconds = 0;
                        this.updateStopwatch();
                        break;
                    case 'count-up':
                        state.timerValue = 0;
                        this.updateTimerDisplay();
                        break;
                    case 'count-down':
                        state.timerValue = state.programConfig['count-down'].initialTime;
                        this.updateTimerDisplay();
                        break;
                    case 'for-time':
                        state.timerValue = 0;
                        this.updateTimerDisplay();
                        break;
                    case 'amrap':
                        state.timerValue = state.programConfig['amrap'].duration;
                        this.updateTimerDisplay();
                        break;
                    case 'emom':
                        state.timerValue = state.programConfig['emom'].totalMinutes * 60;
                        this.updateTimerDisplay();
                        break;
                    case 'hiit':
                        state.timerValue = state.programConfig['hiit'].warmup * 60;
                        this.updateTimerDisplay();
                        break;
                    case 'tabata':
                        state.timerValue = state.programConfig['tabata'].work;
                        this.updateTimerDisplay();
                        break;
                    default:
                        if (state.activeProgram.startsWith('custom-')) {
                            const customId = state.activeProgram.split('-')[1];
                            const customProgram = state.customPrograms.find(p => p.id === customId);
                            if (customProgram) {
                                state.timerValue = customProgram.initialTime || 300;
                                this.updateTimerDisplay();
                            }
                        }
                }
            }
        };

        // Lógica de programas
        const programLogic = {
            setProgram(program) {
                state.activeProgram = program;
                
                // Actualizar clases de botones
                state.elements.programBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.program === program);
                    btn.classList.toggle('bg-base-200', btn.dataset.program !== program);
                });
                
                if (state.isTimerRunning) {
                    timerLogic.pauseTimer();
                }
                
                switch(program) {
                    case 'clock':
                        state.elements.actionBtn.textContent = state.isConnected ? 'Desconectar dispositivo' : 'Enviar al dispositivo';
                        timerLogic.updateClock();
                        break;
                    case 'stopwatch':
                        this.setupStopwatch();
                        break;
                    case 'count-up':
                        this.setupCountUp();
                        break;
                    case 'count-down':
                        this.setupCountDown();
                        break;
                    case 'for-time':
                        this.setupForTime();
                        break;
                    case 'amrap':
                        this.setupAmrap();
                        break;
                    case 'emom':
                        this.setupEmom();
                        break;
                    case 'hiit':
                        this.setupHiit();
                        break;
                    case 'tabata':
                        this.setupTabata();
                        break;
                    default:
                        if (program.startsWith('custom-')) {
                            this.setupCustomProgram(program);
                        }
                }
            },
            
            setupStopwatch() {
                state.countDirection = 'up';
                state.timerValue = 0;
                state.stopwatchCentiseconds = 0;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateStopwatch();
            },
            
            setupCountUp() {
                state.countDirection = 'up';
                state.timerValue = 0;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateTimerDisplay();
            },
            
            setupCountDown() {
                state.countDirection = 'down';
                state.timerValue = state.programConfig['count-down'].initialTime;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateTimerDisplay();
            },
            
            setupForTime() {
                state.countDirection = 'up';
                state.timerValue = 0;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateTimerDisplay();
            },
            
            setupAmrap() {
                state.countDirection = 'down';
                state.timerValue = state.programConfig['amrap'].duration;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateTimerDisplay();
            },
            
            setupEmom() {
                state.countDirection = 'down';
                state.timerValue = state.programConfig['emom'].totalMinutes * 60;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateTimerDisplay();
            },
            
            setupHiit() {
                state.countDirection = state.programConfig['hiit'].direction;
                state.timerValue = state.programConfig['hiit'].warmup * 60;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateTimerDisplay();
            },
            
            setupTabata() {
                state.countDirection = 'down';
                state.timerValue = state.programConfig['tabata'].work;
                state.elements.actionBtn.textContent = 'Iniciar';
                timerLogic.updateTimerDisplay();
            },
            
            setupCustomProgram(program) {
                const customId = program.split('-')[1];
                const customProgram = state.customPrograms.find(p => p.id === customId);
                if (customProgram) {
                    state.countDirection = customProgram.direction || 'down';
                    state.timerValue = customProgram.initialTime || 300;
                    state.elements.actionBtn.textContent = 'Iniciar';
                    timerLogic.updateTimerDisplay();
                }
            }
        };

        // Gestión de programas personalizados
        const customPrograms = {
            createCustomProgramCard(program) {
                const card = document.createElement('div');
                card.className = 'program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all custom-program-card';
                card.dataset.program = `custom-${program.id}`;
                
                const title = document.createElement('div');
                title.className = 'btn-text';
                title.textContent = program.name;
                
                const info = document.createElement('div');
                info.className = 'program-info';
                info.textContent = program.description || 'Programa personalizado';
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-custom';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteCustomProgram(program.id);
                });
                
                card.appendChild(title);
                card.appendChild(info);
                card.appendChild(deleteBtn);
                state.elements.programsContainer.insertBefore(card, state.elements.customProgramBtn);
                
                // Evento para seleccionar el programa
                card.addEventListener('click', () => {
                    if (state.editMode) return;
                    programLogic.setProgram(`custom-${program.id}`);
                });
            },
            
            deleteCustomProgram(id) {
                state.customPrograms = state.customPrograms.filter(p => p.id !== id);
                document.querySelector(`[data-program="custom-${id}"]`).remove();
                this.saveCustomPrograms();
            },
            
            saveCustomPrograms() {
                localStorage.setItem('customPrograms', JSON.stringify(state.customPrograms));
            },
            
            loadCustomPrograms() {
                const saved = localStorage.getItem('customPrograms');
                if (saved) {
                    state.customPrograms = JSON.parse(saved);
                    state.customPrograms.forEach(p => this.createCustomProgramCard(p));
                }
            }
        };

        // Inicialización del modal de creación de programas
        function initProgramCreationModal() {
            const blockList = document.getElementById('blockList');
            
            const createSubBlock = (data = {}) => {
                const template = document.getElementById('sub-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                if (data.name) title.textContent = data.name;
                if (data.userEditedName) title.dataset.userEdited = "true";
                clone.querySelector('[data-field="time"]').value = data.time || "";
                clone.querySelector('[data-field="warning"]').value = data.warning || "";
                const direction = data.direction || "up";
                clone.querySelector('[data-field="direction"]').value = direction;
                const dirButton = clone.querySelector(`[data-action="set-direction"][data-value="${direction}"]`);
                if (dirButton) dirButton.classList.add("bg-primary", "text-primary-content");
                return clone;
            };
            
            const createMainBlock = (data = {}) => {
                const template = document.getElementById('main-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                const select = clone.querySelector('[data-field="repeat"]');
                
                let repeatOptions = '<option value="1">No repetir este bloque</option>';
                for (let i = 2; i <= 99; i++) repeatOptions += `<option value="${i}">Repetir ${i} veces</option>`;
                select.innerHTML = repeatOptions;
                
                if (data.name) title.textContent = data.name;
                if (data.userEditedName) title.dataset.userEdited = "true";
                select.value = data.repeat || 1;
                
                const subBlockContainer = clone.querySelector(".sub-block-list-container");
                if (data.blocks && data.blocks.length > 0) {
                    data.blocks.forEach(subBlockData => subBlockContainer.appendChild(createSubBlock(subBlockData)));
                } else {
                    subBlockContainer.appendChild(createSubBlock());
                }
                
                return clone;
            };
            
            // Renumerar bloques para mantener el orden
            const renumberBlocks = () => {
                let mainBlockCount = 0;
                blockList.querySelectorAll(":scope > .main-block").forEach(mainBlock => {
                    mainBlockCount++;
                    const title = mainBlock.querySelector('[data-action="edit-title"]');
                    if (!title.dataset.userEdited) {
                        title.textContent = `Bloque ${mainBlockCount}`;
                    }
                    
                    let subBlockCount = 0;
                    mainBlock.querySelectorAll(".sub-block-list-container > .block-item").forEach(subBlock => {
                        subBlockCount++;
                        const subTitle = subBlock.querySelector('[data-action="edit-title"]');
                        if (!subTitle.dataset.userEdited) {
                            subTitle.textContent = `Sub Bloque ${subBlockCount}`;
                        }
                    });
                });
            };
            
            blockList.addEventListener("click", (e) => {
                const button = e.target.closest("[data-action]");
                if (!button) return;
                
                const action = button.dataset.action;
                const block = button.closest(".main-block, .block-item");
                
                switch (action) {
                    case "delete-block":
                        block.remove();
                        renumberBlocks();
                        break;
                    case "toggle-content":
                        const content = block.querySelector(".content");
                        content.classList.toggle("hidden");
                        button.innerHTML = content.classList.contains("hidden") ? "▼" : "▲";
                        break;
                    case "add-sub-block":
                        block.querySelector(".sub-block-list-container").appendChild(createSubBlock());
                        renumberBlocks();
                        break;
                    case "edit-title":
                        if (button.querySelector("input")) return;
                        const currentText = button.textContent;
                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = currentText;
                        input.className = "input input-ghost input-xs w-full";
                        input.addEventListener("blur", () => {
                            const newValue = input.value.trim() || currentText;
                            button.textContent = newValue;
                            if (newValue && !newValue.match(/^(Bloque|Sub Bloque) \d+$/i)) {
                                button.dataset.userEdited = "true";
                            } else {
                                delete button.dataset.userEdited;
                            }
                            renumberBlocks();
                        });
                        input.addEventListener("keydown", (e) => e.key === "Enter" && e.target.blur());
                        button.innerHTML = "";
                        button.appendChild(input);
                        input.focus();
                        break;
                    case "set-direction":
                        const parent = button.parentElement;
                        parent.querySelectorAll("button").forEach(btn => 
                            btn.classList.remove("bg-primary", "text-primary-content")
                        );
                        button.classList.add("bg-primary", "text-primary-content");
                        parent.querySelector('input[data-field="direction"]').value = button.dataset.value;
                        break;
                }
            });
            
            blockList.addEventListener("focusin", (e) => {
                if (e.target.matches('[data-field="time"], [data-field="warning"]') && !e.target.value) {
                    e.target.value = "00:00";
                }
            });
            
            blockList.addEventListener("input", (e) => {
                if (e.target.matches('[data-field="time"], [data-field="warning"]')) {
                    utils.formatTimeInput(e.target);
                }
            });
            
            document.getElementById('addMainBlockBtn').addEventListener("click", () => {
                blockList.appendChild(createMainBlock());
                renumberBlocks();
            });
            
            document.getElementById('cancelCreate').addEventListener("click", () => {
                state.elements.createProgramModal.close();
            });
            
            document.getElementById('programForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const programName = document.getElementById('program-name').value;
                const programId = 'custom-' + Date.now();
                const newProgram = {
                    id: programId,
                    name: programName,
                    description: document.getElementById('program-description').value,
                    countdown: document.getElementById('countdown').value,
                    initialTime: 300,
                    direction: 'down'
                };
                
                state.customPrograms.push(newProgram);
                customPrograms.createCustomProgramCard(newProgram);
                customPrograms.saveCustomPrograms();
                state.elements.createProgramModal.close();
                document.getElementById('programForm').reset();
                blockList.innerHTML = '';
            });
        }

        // Configuración de eventos
        function setupEventListeners() {
            // Botón de acción principal
            state.elements.actionBtn.addEventListener('click', () => {
                if (state.countdownActive) {
                    countdownLogic.cancelCountdown();
                    return;
                }
                
                if (state.activeProgram === 'clock') {
                    state.isConnected = !state.isConnected;
                    state.elements.actionBtn.textContent = state.isConnected ? 
                        'Desconectar dispositivo' : 'Enviar al dispositivo';
                } else {
                    state.isTimerRunning ? timerLogic.pauseTimer() : timerLogic.startTimer();
                }
            });
            
            // Botón de reset
            state.elements.resetBtn.addEventListener('click', () => {
                if (state.countdownActive) {
                    countdownLogic.cancelCountdown();
                } else {
                    timerLogic.resetTimer();
                }
            });
            
            // Botón de reset en modo concentración
            state.elements.concentrationResetBtn.addEventListener('click', () => {
                timerLogic.resetTimer();
            });
            
            // Modo edición
            state.elements.editCorner.addEventListener('click', () => {
                state.editMode = !state.editMode;
                document.body.classList.toggle('edit-mode', state.editMode);
                const editIcon = state.elements.editCorner.querySelector('i');
                editIcon.className = state.editMode ? 'fas fa-check' : 'fas fa-pencil-alt';
                state.elements.customProgramBtn.classList.toggle('hidden', !state.editMode);
                
                // Mostrar u ocultar botones de eliminar
                document.querySelectorAll('.delete-custom').forEach(btn => {
                    btn.style.display = state.editMode ? 'flex' : 'none';
                });
            });
            
            // Configuración global
            state.elements.globalConfigBtn.addEventListener('click', () => state.elements.configModal.showModal());
            
            // Tema
            state.elements.themeSwitcher.addEventListener('change', (e) => {
                document.documentElement.setAttribute('data-theme', e.target.value);
                document.body.classList.toggle('light-theme', 
                    ['light', 'corporate'].includes(e.target.value));
            });
            
            // Efecto de retroiluminación
            state.elements.glowEffectToggle.addEventListener('change', (e) => {
                state.glowEffectEnabled = e.target.checked;
                document.body.classList.toggle('glow-effect', state.glowEffectEnabled);
            });
            
            // Auto fullscreen
            state.elements.autoFullscreenToggle.addEventListener('change', (e) => {
                state.autoFullscreen = e.target.checked;
            });
            
            // Cuenta regresiva por defecto
            state.elements.defaultCountdownSelect.addEventListener('change', (e) => {
                state.defaultCountdown = parseInt(e.target.value);
            });
            
            // Intensidad LED
            state.elements.ledIntensity.addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--glow-intensity', `${e.target.value}px`);
            });
            
            // Guardar configuración
            document.getElementById('save-config').addEventListener('click', () => {
                localStorage.setItem('glowEffect', state.elements.glowEffectToggle.checked);
                localStorage.setItem('ledIntensity', state.elements.ledIntensity.value);
                localStorage.setItem('autoFullscreen', state.elements.autoFullscreenToggle.checked);
                localStorage.setItem('defaultCountdown', state.defaultCountdown);
            });
            
            // Modo concentración - ahora funciona con todos los programas
            state.elements.fullscreenBtn.addEventListener('click', () => {
                state.isFullscreen = true;
                state.elements.concentrationMode.classList.remove('hidden');
            });
            
            state.elements.concentrationActionBtn.addEventListener('click', () => {
                state.isTimerRunning ? timerLogic.pauseTimer() : timerLogic.startTimer();
            });
            
            state.elements.minimizeBtn.addEventListener('click', () => {
                state.isFullscreen = false;
                state.elements.concentrationMode.classList.add('hidden');
            });
            
            // Crear programa personalizado
            state.elements.customProgramBtn.addEventListener('click', () => {
                if (state.editMode) state.elements.createProgramModal.showModal();
            });
            
            // Configuración de programas
            const configurablePrograms = ['count-up', 'count-down', 'amrap', 'emom', 'hiit', 'tabata'];
            const modals = {
                'count-up': document.getElementById('config-count-up-modal'),
                'count-down': document.getElementById('config-count-down-modal'),
                'amrap': document.getElementById('config-amrap-modal'),
                'emom': document.getElementById('config-emom-modal'),
                'hiit': document.getElementById('config-hiit-modal'),
                'tabata': document.getElementById('config-tabata-modal')
            };
            
            // Configurar botones de cancelar para los modales
            const cancelButtons = {
                'count-up': document.getElementById('cancel-count-up'),
                'count-down': document.getElementById('cancel-count-down'),
                'amrap': document.getElementById('cancel-amrap'),
                'emom': document.getElementById('cancel-emom'),
                'hiit': document.getElementById('cancel-hiit'),
                'tabata': document.getElementById('cancel-tabata')
            };
            
            // Configurar botones de aplicar para los modales
            const applyButtons = {
                'count-up': document.getElementById('apply-count-up'),
                'count-down': document.getElementById('apply-count-down'),
                'amrap': document.getElementById('apply-amrap'),
                'emom': document.getElementById('apply-emom'),
                'hiit': document.getElementById('apply-hiit'),
                'tabata': document.getElementById('apply-tabata')
            };
            
            // Configurar evento de cancelar para cerrar el modal
            Object.keys(cancelButtons).forEach(program => {
                const cancelButton = cancelButtons[program];
                if (cancelButton) {
                    cancelButton.addEventListener('click', () => {
                        if (modals[program]) {
                            modals[program].close();
                        }
                    });
                }
            });
            
            // Configurar evento de aplicar para guardar la configuración
            Object.keys(applyButtons).forEach(program => {
                const applyButton = applyButtons[program];
                if (applyButton) {
                    applyButton.addEventListener('click', () => {
                        switch(program) {
                            case 'count-up':
                                state.programConfig['count-up'].maxTime = utils.timeToSeconds(
                                    document.getElementById('count-up-max').value
                                );
                                break;
                            case 'count-down':
                                state.programConfig['count-down'].initialTime = utils.timeToSeconds(
                                    document.getElementById('count-down-init').value
                                );
                                break;
                            case 'amrap':
                                state.programConfig['amrap'].duration = utils.timeToSeconds(
                                    document.getElementById('amrap-duration').value
                                );
                                break;
                            case 'emom':
                                state.programConfig['emom'].totalMinutes = parseInt(document.getElementById('emom-total').value);
                                state.programConfig['emom'].reps = parseInt(document.getElementById('emom-reps').value);
                                break;
                            case 'hiit':
                                state.programConfig['hiit'].warmup = parseInt(document.getElementById('hiit-warmup').value);
                                state.programConfig['hiit'].work = parseInt(document.getElementById('hiit-work').value);
                                state.programConfig['hiit'].rest = parseInt(document.getElementById('hiit-rest').value);
                                state.programConfig['hiit'].rounds = parseInt(document.getElementById('hiit-rounds').value);
                                state.programConfig['hiit'].cooldown = parseInt(document.getElementById('hiit-cooldown').value);
                                state.programConfig['hiit'].direction = 
                                    document.querySelector('input[name="hiit-direction"]:checked').value;
                                break;
                            case 'tabata':
                                state.programConfig['tabata'].rounds = parseInt(document.getElementById('tabata-rounds').value);
                                state.programConfig['tabata'].work = parseInt(document.getElementById('tabata-work').value);
                                state.programConfig['tabata'].rest = parseInt(document.getElementById('tabata-rest').value);
                                break;
                        }
                        programLogic.setProgram(program);
                        if (modals[program]) {
                            modals[program].close();
                        }
                    });
                }
            });
            
            configurablePrograms.forEach(program => {
                document.querySelector(`[data-program="${program}"]`).addEventListener('click', () => {
                    if (state.editMode) {
                        // Configurar y mostrar modal
                        switch(program) {
                            case 'count-up':
                                document.getElementById('count-up-max').value = 
                                    utils.secondsToTime(state.programConfig['count-up'].maxTime);
                                break;
                            case 'count-down':
                                document.getElementById('count-down-init').value = 
                                    utils.secondsToTime(state.programConfig['count-down'].initialTime);
                                break;
                            case 'amrap':
                                document.getElementById('amrap-duration').value = 
                                    utils.secondsToTime(state.programConfig['amrap'].duration);
                                break;
                            case 'emom':
                                document.getElementById('emom-total').value = state.programConfig['emom'].totalMinutes;
                                document.getElementById('emom-reps').value = state.programConfig['emom'].reps;
                                break;
                            case 'hiit':
                                document.getElementById('hiit-warmup').value = state.programConfig['hiit'].warmup;
                                document.getElementById('hiit-work').value = state.programConfig['hiit'].work;
                                document.getElementById('hiit-rest').value = state.programConfig['hiit'].rest;
                                document.getElementById('hiit-rounds').value = state.programConfig['hiit'].rounds;
                                document.getElementById('hiit-cooldown').value = state.programConfig['hiit'].cooldown;
                                document.querySelector(`#hiit-${state.programConfig['hiit'].direction}`).checked = true;
                                break;
                            case 'tabata':
                                document.getElementById('tabata-rounds').value = state.programConfig['tabata'].rounds;
                                document.getElementById('tabata-work').value = state.programConfig['tabata'].work;
                                document.getElementById('tabata-rest').value = state.programConfig['tabata'].rest;
                                break;
                        }
                        if (modals[program]) {
                            modals[program].showModal();
                        }
                    } else {
                        programLogic.setProgram(program);
                    }
                });
            });
            
            // Programas sin configuración
            ['clock', 'stopwatch', 'for-time'].forEach(program => {
                document.querySelector(`[data-program="${program}"]`).addEventListener('click', () => {
                    if (!state.editMode) programLogic.setProgram(program);
                });
            });
        }

        // Inicialización de la aplicación
        function initApp() {
            initElements();
            setupEventListeners();
            initProgramCreationModal();
            customPrograms.loadCustomPrograms();
            programLogic.setProgram('clock');
            
            // Actualizar reloj cada segundo
            setInterval(() => {
                if (state.activeProgram === 'clock') {
                    timerLogic.updateClock();
                }
            }, 1000);
            
            // Cargar configuración guardada
            const savedGlow = localStorage.getItem('glowEffect');
            if (savedGlow !== null) {
                state.glowEffectEnabled = savedGlow === 'true';
                state.elements.glowEffectToggle.checked = state.glowEffectEnabled;
                document.body.classList.toggle('glow-effect', state.glowEffectEnabled);
            }
            
            const savedIntensity = localStorage.getItem('ledIntensity');
            if (savedIntensity !== null) {
                state.elements.ledIntensity.value = savedIntensity;
                document.documentElement.style.setProperty('--glow-intensity', `${savedIntensity}px`);
            }
            
            const savedAutoFullscreen = localStorage.getItem('autoFullscreen');
            if (savedAutoFullscreen !== null) {
                state.autoFullscreen = savedAutoFullscreen === 'true';
                state.elements.autoFullscreenToggle.checked = state.autoFullscreen;
            }
            
            const savedDefaultCountdown = localStorage.getItem('defaultCountdown');
            if (savedDefaultCountdown !== null) {
                state.defaultCountdown = parseInt(savedDefaultCountdown);
                if (state.elements.defaultCountdownSelect) {
                    state.elements.defaultCountdownSelect.value = state.defaultCountdown;
                }
            }
        }

        // Iniciar la aplicación
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
