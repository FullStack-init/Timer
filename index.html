<!DOCTYPE html>
<html lang="es" class="h-full bg-base-200 text-base-content">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fitness Timer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.7.0/dist/full.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script>
        tailwind.config = {
            darkMode: "class",
            plugins: [require("daisyui")],
            daisyui: {
                themes: ["luxury", "cyberpunk", "forest", "lofi", "corporate", "light", "abyss", "synthwave", "black", "dark"],
                darkTheme: "luxury"
            }
        };
    </script>
    <style>
        :root {
            --led-on: #00fffc;
            --led-off: rgba(0, 100, 100, 0.1);
            --glow-intensity: 10px;
        }
        
        .light-theme {
            --led-on: #00a8a8;
            --led-off: rgba(0, 0, 0, 0.05);
        }
        
        .segment {
            position: absolute;
            background: var(--led-off);
            border-radius: 3px;
            transition: all 0.1s;
        }
        
        .segment.on {
            background: var(--led-on);
            box-shadow: 0 0 var(--glow-intensity) var(--led-on);
        }
        
        .glow-effect .segment.on {
            box-shadow: 0 0 15px 5px var(--led-on);
        }
        
        .segment-a { width: 40px; height: 8px; top: 0; left: 10px; }
        .segment-b { width: 8px; height: 40px; top: 8px; right: 0; }
        .segment-c { width: 8px; height: 40px; bottom: 8px; right: 0; }
        .segment-d { width: 40px; height: 8px; bottom: 0; left: 10px; }
        .segment-e { width: 8px; height: 40px; bottom: 8px; left: 0; }
        .segment-f { width: 8px; height: 40px; top: 8px; left: 0; }
        .segment-g { width: 40px; height: 8px; top: 50%; left: 10px; transform: translateY(-50%); }
        
        .colon {
            width: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            height: 100%;
        }
        
        .colon-dot {
            width: 8px;
            height: 8px;
            background: var(--led-on);
            border-radius: 50%;
            margin: 15px 0;
            opacity: 0.7;
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 252, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 252, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 252, 0); }
        }

        .edit-mode .program-btn {
            animation: pulse 2s infinite;
        }
        
        .edit-mode .program-btn:hover {
            animation: shake 0.5s ease infinite;
            transform: translateY(0);
        }
        
        .concentration-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .concentration-display {
            transform: scale(1.5);
            margin-bottom: 3rem;
        }
        
        .concentration-controls {
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        
        .concentration-controls:hover {
            opacity: 1;
        }
        
        .display-container {
            background: rgba(15, 15, 25, 0.9);
            border-radius: 16px;
            padding: 15px 25px;
            box-shadow: 
                0 0 25px rgba(0, 0, 0, 0.6),
                inset 0 0 10px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(80, 80, 100, 0.3);
            aspect-ratio: 16/6;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .digits {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: relative;
            padding: 5px 0;
        }
        
        .digit-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            padding: 0 5px;
        }
        
        .digit {
            position: relative;
            width: 60px; 
            height: 100px;
            margin: 0 3px;
            flex-shrink: 0;
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 150, 150, 0.3);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--led-on);
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .fullscreen-btn:hover {
            opacity: 1;
        }
        
        .custom-program-card {
            position: relative;
        }
        
        .delete-custom {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff0000;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .edit-mode .custom-program-card .delete-custom {
            display: flex;
        }
        
        .program-btn.active {
            background: #3b82f6 !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        
        .program-btn.running {
            animation: pulse 1.5s infinite;
        }
        
        .program-info {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        
        @media (max-width: 480px) {
            .digit {
                width: 45px;
                height: 75px;
            }
            
            .segment-a { width: 30px; height: 6px; left: 7px; }
            .segment-b { width: 6px; height: 30px; top: 6px; }
            .segment-c { width: 6px; height: 30px; bottom: 6px; }
            .segment-d { width: 30px; height: 6px; left: 7px; }
            .segment-e { width: 6px; height: 30px; bottom: 6px; }
            .segment-f { width: 6px; height: 30px; top: 6px; }
            .segment-g { width: 30px; height: 6px; left: 7px; }
            
            .colon {
                width: 12px;
            }
            
            .colon-dot {
                width: 6px;
                height: 6px;
                margin: 12px 0;
            }
        }
    </style>
</head>
<body class="h-full flex flex-col glow-effect">
    <!-- Navbar -->
    <nav class="navbar bg-base-300 px-4 py-3 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div class="app-name text-xl font-bold text-primary flex items-center gap-2">
            <i class="fas fa-dumbbell"></i>
            FITNESS TIMER PRO
        </div>
        <div class="nav-actions flex items-center gap-3">
            <button id="global-config-btn" class="btn btn-ghost btn-circle" title="Configuración global">
                <i class="fas fa-cog"></i>
            </button>
            <div class="wifi-status badge badge-outline badge-primary gap-2">
                <i class="fas fa-wifi"></i>
                <span>Conectado</span>
            </div>
        </div>
    </nav>
    
    <!-- Contenido principal -->
    <main class="container mx-auto p-4 max-w-lg flex-1 flex flex-col">
        <!-- Display principal optimizado -->
        <div class="display-container relative">
            <button class="fullscreen-btn" id="fullscreen-btn">
                <i class="fas fa-expand"></i>
            </button>
            <div class="digits" id="display"></div>
        </div>
        
        <!-- Botón de acción principal inteligente -->
        <button id="action-btn" class="btn btn-primary btn-lg w-full my-4">Iniciar</button>
        
        <!-- Programas de entrenamiento -->
        <div class="programs-section bg-base-100 rounded-2xl p-4 shadow-lg border border-base-300 relative">
            <div class="edit-corner absolute top-0 right-0 w-10 h-10 flex items-center justify-center bg-primary text-primary-content rounded-bl-2xl cursor-pointer" id="edit-corner">
                <i class="fas fa-pencil-alt"></i>
            </div>
            
            <div class="section-header mb-4">
                <h2 class="section-title text-lg font-semibold text-center">
                    Programas de Entrenamiento
                </h2>
            </div>
            <div class="programs grid grid-cols-3 gap-3" id="programs-container">
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="clock">
                    <div class="btn-text">Reloj</div>
                    <div class="program-info">Hora actual</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="stopwatch">
                    <div class="btn-text">Cronómetro</div>
                    <div class="program-info">Cuenta ascendente</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="count-up">
                    <div class="btn-text">Contador Asc.</div>
                    <div class="program-info">Hasta límite</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="count-down">
                    <div class="btn-text">Contador Desc.</div>
                    <div class="program-info">Desde inicial</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="amrap">
                    <div class="btn-text">AMRAP</div>
                    <div class="program-info">Tantas rondas</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="tabata">
                    <div class="btn-text">TABATA</div>
                    <div class="program-info">20s trabajo/10s desc</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="emom">
                    <div class="btn-text">EMOM</div>
                    <div class="program-info">Cada minuto</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="hiit">
                    <div class="btn-text">HIIT</div>
                    <div class="program-info">Entrenamiento intenso</div>
                </div>
                <div class="program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all" data-program="for-time">
                    <div class="btn-text">For Time</div>
                    <div class="program-info">Tiempo total</div>
                </div>
                <div class="program-btn custom hidden aspect-square bg-base-200 border-2 border-dashed border-primary rounded-xl p-3 text-center cursor-pointer transition-all" data-program="custom">
                    <div class="custom-program-text text-primary font-semibold text-sm">
                        <i class="fas fa-plus-circle"></i>
                        Crear programa
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-300 text-base-content">
        <aside>
            <p>Conectado a dispositivo físico • Versión 2.5</p>
        </aside>
    </footer>

    <!-- Modales -->
    <!-- Modal de configuración global -->
    <dialog id="config-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configuración Global</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tema de color</span>
                    </label>
                    <select id="themeSwitcher" class="select select-bordered">
                        <option value="luxury">Luxury</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="forest">Forest</option>
                        <option value="lofi">Lofi</option>
                        <option value="corporate">Corporate</option>
                        <option value="light">Light</option>
                        <option value="abyss">Abyss</option>
                        <option value="synthwave">Synthwave</option>
                        <option value="black">Black</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Sonidos</span> 
                        <input type="checkbox" class="toggle toggle-primary" checked />
                    </label>
                </div>
                
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-4">
                        <span class="label-text">Efecto retroiluminación</span> 
                        <input type="checkbox" id="glow-effect-toggle" class="toggle toggle-primary" checked />
                    </label>
                </div>
                
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Intensidad de LEDs</span>
                    </label>
                    <input type="range" min="1" max="10" value="8" class="range range-primary" id="led-intensity" />
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-ghost">Cancelar</button>
                    <button class="btn btn-primary" id="save-config">Guardar</button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- Modal de creación de programas -->
    <dialog id="create-program-modal" class="modal">
        <div class="modal-box max-w-md w-full">
            <form method="dialog" id="programForm">
                <header class="flex justify-between items-center pb-2">
                    <h3 class="font-bold text-lg">Crear programa</h3>
                    <button type="button" class="btn btn-circle btn-ghost btn-sm" id="closeDialogBtn">
                        ×
                    </button>
                </header>
                <div class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <input
                            type="text"
                            id="program-name"
                            placeholder="Nombre del programa"
                            required
                            class="input input-bordered input-sm w-full text-sm"
                        />
                        <select
                            id="countdown"
                            class="select select-bordered select-sm w-full text-sm"
                        >
                            <option value="0">Sin cuenta regresiva</option>
                            <option value="3">3 segundos</option>
                            <option value="5">5 segundos</option>
                            <option value="10">10 segundos</option>
                            <option value="15">15 segundos</option>
                            <option value="20">20 segundos</option>
                            <option value="30">30 segundos</option>
                        </select>
                    </div>
                    <textarea
                        id="program-description"
                        placeholder="Descripción del programa (opcional)"
                        class="textarea textarea-bordered textarea-sm w-full text-sm"
                    ></textarea>
                </div>
                <div class="mt-3">
                    <h4 class="mb-2 font-semibold text-sm">Bloques de tiempo:</h4>
                    <div
                        id="blockList"
                        class="block-list-container border border-dashed border-transparent"
                    ></div>
                </div>
                <div class="mt-3 flex gap-2 justify-center">
                    <button
                        type="button"
                        id="addMainBlockBtn"
                        class="btn btn-outline btn-sm w-full"
                    >
                        + Añadir Bloque
                    </button>
                </div>
                <div class="modal-action mt-3">
                    <button
                        type="button"
                        id="cancelCreate"
                        class="btn btn-ghost btn-sm"
                    >
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Modales de configuración de programas -->
    <!-- Modal Contador Ascendente -->
    <dialog id="config-count-up-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Contador Ascendente</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tiempo máximo (mm:ss)</span>
                    </label>
                    <input type="text" id="count-up-max" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es el Contador Ascendente?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">El contador ascendente comienza en 00:00 y cuenta hacia arriba hasta el tiempo máximo que configures. Es útil para medir cuánto tiempo llevas en una actividad.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-count-up">Cancelar</button>
                <button class="btn btn-primary" id="apply-count-up">Aplicar</button>
            </div>
        </div>
    </dialog>

    <!-- Modal Contador Descendente -->
    <dialog id="config-count-down-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Contador Descendente</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tiempo inicial (mm:ss)</span>
                    </label>
                    <input type="text" id="count-down-init" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es el Contador Descendente?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">Comienza en el tiempo configurado y cuenta hacia abajo hasta 00:00. Ideal para ejercicios con tiempo límite.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-count-down">Cancelar</button>
                <button class="btn btn-primary" id="apply-count-down">Aplicar</button>
            </div>
        </div>
    </dialog>

    <!-- Modal AMRAP -->
    <dialog id="config-amrap-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar AMRAP</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Duración (mm:ss)</span>
                    </label>
                    <input type="text" id="amrap-duration" class="input input-bordered" placeholder="00:00" value="05:00">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es AMRAP?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">AMRAP (As Many Rounds As Possible): Completa tantas rondas como sea posible de un circuito en el tiempo establecido. El tiempo corre en cuenta regresiva.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-amrap">Cancelar</button>
                <button class="btn btn-primary" id="apply-amrap">Aplicar</button>
            </div>
        </div>
    </dialog>

    <!-- Modal EMOM -->
    <dialog id="config-emom-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar EMOM</h3>
            <div class="py-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Duración total (minutos)</span>
                    </label>
                    <input type="number" id="emom-total" class="input input-bordered" min="1" max="60" value="10">
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Repeticiones por minuto</span>
                    </label>
                    <input type="number" id="emom-reps" class="input input-bordered" min="1" max="20" value="10">
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es EMOM?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">EMOM (Every Minute On the Minute): Realiza los ejercicios al inicio de cada minuto. El tiempo restante del minuto es para descanso. El contador es descendente.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-emom">Cancelar</button>
                <button class="btn btn-primary" id="apply-emom">Aplicar</button>
            </div>
        </div>
    </dialog>

    <!-- Modal HIIT -->
    <dialog id="config-hiit-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar HIIT</h3>
            <div class="py-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Calentamiento</span>
                        </label>
                        <select id="hiit-warmup" class="select select-bordered">
                            <option value="0">0 min</option>
                            <option value="3">3 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="7">7 min</option>
                            <option value="10">10 min</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trabajo intenso</span>
                        </label>
                        <select id="hiit-work" class="select select-bordered">
                            <option value="20" selected>20 s</option>
                            <option value="30">30 s</option>
                            <option value="40">40 s</option>
                            <option value="45">45 s</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Descanso</span>
                        </label>
                        <select id="hiit-rest" class="select select-bordered">
                            <option value="10" selected>10 s</option>
                            <option value="15">15 s</option>
                            <option value="20">20 s</option>
                            <option value="30">30 s</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Repeticiones</span>
                        </label>
                        <select id="hiit-rounds" class="select select-bordered">
                            <option value="4">4</option>
                            <option value="6">6</option>
                            <option value="8" selected>8</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Enfriamiento</span>
                        </label>
                        <select id="hiit-cooldown" class="select select-bordered">
                            <option value="0">0 min</option>
                            <option value="3">3 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="7">7 min</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Dirección</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="radio" name="hiit-direction" id="hiit-down" value="down" class="radio radio-primary" checked>
                            <label for="hiit-down">Descendente</label>
                            <input type="radio" name="hiit-direction" id="hiit-up" value="up" class="radio radio-primary">
                            <label for="hiit-up">Ascendente</label>
                        </div>
                    </div>
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es HIIT?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">HIIT (High Intensity Interval Training): Alterna períodos de ejercicio intenso con descanso. Este temporizador maneja calentamiento, ciclos de trabajo/descanso y enfriamiento.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-hiit">Cancelar</button>
                <button class="btn btn-primary" id="apply-hiit">Aplicar</button>
            </div>
        </div>
    </dialog>

    <!-- Modal TABATA -->
    <dialog id="config-tabata-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurar TABATA</h3>
            <div class="py-4">
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Rondas</span>
                        </label>
                        <input type="number" id="tabata-rounds" class="input input-bordered" min="1" max="20" value="8">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trabajo (s)</span>
                        </label>
                        <input type="number" id="tabata-work" class="input input-bordered" min="5" max="60" value="20">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Descanso (s)</span>
                        </label>
                        <input type="number" id="tabata-rest" class="input input-bordered" min="5" max="60" value="10">
                    </div>
                </div>
                <div class="collapse collapse-arrow mt-4">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i> ¿Qué es TABATA?
                    </div>
                    <div class="collapse-content bg-base-100"> 
                        <p class="py-2">Protocolo de 20 segundos de trabajo intenso seguidos de 10 segundos de descanso, repetido por 8 rondas (4 minutos totales). Puedes personalizar estos valores.</p>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" id="cancel-tabata">Cancelar</button>
                <button class="btn btn-primary" id="apply-tabata">Aplicar</button>
            </div>
        </div>
    </dialog>

    <!-- Modo concentración -->
    <div class="concentration-mode hidden" id="concentration-mode">
        <div class="concentration-display" id="concentration-display"></div>
        <div class="concentration-controls flex gap-4">
            <button class="btn btn-primary" id="concentration-action-btn">
                <i class="fas fa-play"></i>
            </button>
            <button class="btn btn-ghost text-white" id="minimize-btn">
                <i class="fas fa-compress"></i> Minimizar
            </button>
        </div>
    </div>

    <!-- Plantillas para bloques -->
    <template id="main-block-template">
      <article
        class="card mb-2 shadow hover:shadow-lg transition-all duration-200 bg-base-300 border border-base-content/20 main-block"
      >
        <div class="card-body p-2 relative">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-grow">
              <button
                type="button"
                class="btn btn-xs btn-ghost mr-1"
                data-action="toggle-content"
              >
                ▼
              </button>
              <h3
                class="font-bold text-base flex-grow cursor-pointer"
                data-action="edit-title"
              >
                Bloque
              </h3>
            </div>
            <button
              type="button"
              class="btn btn-xs btn-ghost ml-auto"
              aria-label="Eliminar bloque"
              data-action="delete-block"
            >
              ×
            </button>
          </div>
          <div
            class="content hidden mt-2 pt-2 border-t border-base-content/10 flex flex-col gap-2"
          >
            <div class="flex items-center">
              <select
                class="select select-sm select-bordered w-full"
                data-field="repeat"
              ></select>
            </div>
            <h5 class="text-xs font-semibold">Sub Bloques de tiempo:</h5>
            <div
              class="sub-block-list-container block-list-container border border-dashed border-transparent rounded"
            ></div>
            <button
              type="button"
              class="btn btn-outline btn-xs w-full"
              data-action="add-sub-block"
            >
              + Añadir Sub Bloque
            </button>
          </div>
        </div>
      </article>
    </template>
    
    <template id="sub-block-template">
      <article
        class="card mb-1 shadow hover:shadow-lg transition-all duration-200 bg-base-100 border border-base-content/10 block-item"
      >
        <div class="card-body p-1 pt-2 relative">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-grow">
              <button
                type="button"
                class="btn btn-xs btn-ghost mr-1"
                data-action="toggle-content"
              >
                ▼
              </button>
              <h3
                class="text-sm font-medium flex-grow cursor-pointer"
                data-action="edit-title"
              >
                Sub Bloque
              </h3>
            </div>
            <button
              type="button"
              class="btn btn-xs btn-ghost ml-auto"
              aria-label="Eliminar bloque"
              data-action="delete-block"
            >
              ×
            </button>
          </div>
          <div class="content hidden mt-1 pt-1 border-t border-base-content/10">
            <div class="flex flex-col gap-1">
              <div
                class="flex flex-wrap justify-evenly items-center gap-1 w-full min-w-0"
              >
                <div class="flex justify-center min-w-0 w-16">
                  <input
                    type="text"
                    placeholder="Tiempo"
                    class="input input-xs input-bordered min-w-[3rem] max-w-[4.5rem] text-center text-xs"
                    data-field="time"
                  />
                </div>
                <div class="flex justify-center min-w-0 w-16">
                  <input
                    type="text"
                    placeholder="Aviso"
                    class="input input-xs input-bordered min-w-[3rem] max-w-[4.5rem] text-center text-xs"
                    data-field="warning"
                  />
                </div>
                <div class="relative flex justify-center min-w-0">
                  <div class="absolute -top-3.5 left-10 z-20 tooltip tooltip-left tooltip-info tooltip-click" 
                       data-tip="Elige la dirección del tiempo: ascendente (sube) o descendente (baja).">
                    <button type="button" 
                            class="btn p-0 min-h-[0.85rem] h-[0.85rem] w-[0.85rem] 
                                   border border-base-content/20 bg-base-200 text-base-content/70 
                                   rounded-full hover:bg-base-300 hover:text-base-content 
                                   transition-all duration-150">
                      <i class="fas fa-info text-[0.55rem]"></i>
                    </button>
                  </div>
                  
                  <div class="flex rounded-full border border-base-content/10 bg-base-100">
                    <button
                      type="button"
                      class="btn btn-ghost btn-xs text-base px-1 py-0.5 rounded-l-full !rounded-r-none"
                      data-action="set-direction"
                      data-value="up"
                    >
                      <i class="fas fa-arrow-up text-xs"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-ghost btn-xs text-base px-1 py-0.5 rounded-r-full !rounded-l-none"
                      data-action="set-direction"
                      data-value="down"
                    >
                      <i class="fas fa-arrow-down text-xs"></i>
                    </button>
                    <input type="hidden" data-field="direction" value="up" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </article>
    </template>

    <script>
        // Configuración
        const digitMap = [
            ['a', 'b', 'c', 'd', 'e', 'f'],     // 0
            ['b', 'c'],                          // 1
            ['a', 'b', 'g', 'e', 'd'],          // 2
            ['a', 'b', 'g', 'c', 'd'],          // 3
            ['f', 'g', 'b', 'c'],               // 4
            ['a', 'f', 'g', 'c', 'd'],          // 5
            ['a', 'f', 'g', 'c', 'd', 'e'],     // 6
            ['a', 'b', 'c'],                    // 7
            ['a', 'b', 'c', 'd', 'e', 'f', 'g'],// 8
            ['a', 'b', 'c', 'd', 'f', 'g']      // 9
        ];
        
        // Estado
        let activeProgram = 'clock';
        let timerValue = 0;
        let isTimerRunning = false;
        let timerInterval;
        let countDirection = 'down';
        let isConnected = false;
        let editMode = false;
        let stopwatchCentiseconds = 0;
        let stopwatchInterval = null;
        let isFullscreen = false;
        let glowEffectEnabled = true;
        
        // Configuraciones de programas
        const programConfig = {
            'count-up': { maxTime: 300 }, // 5 min en segundos
            'count-down': { initialTime: 300 },
            'amrap': { duration: 300 },
            'emom': { totalMinutes: 10, reps: 10 },
            'hiit': { 
                warmup: 5, // min
                work: 20, // seg
                rest: 10, // seg
                rounds: 8,
                cooldown: 5, // min
                direction: 'down'
            },
            'tabata': { rounds: 8, work: 20, rest: 10 },
            'for-time': { maxTime: 600 } // 10 min
        };
        
        // Programas personalizados
        let customPrograms = [];
        
        // Elementos
        const display = document.getElementById('display');
        const actionBtn = document.getElementById('action-btn');
        const programBtns = document.querySelectorAll('.program-btn');
        const globalConfigBtn = document.getElementById('global-config-btn');
        const editCorner = document.getElementById('edit-corner');
        const configModal = document.getElementById('config-modal');
        const createProgramModal = document.getElementById('create-program-modal');
        const themeSwitcher = document.getElementById('themeSwitcher');
        const customProgramBtn = document.querySelector('.program-btn.custom');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const concentrationMode = document.getElementById('concentration-mode');
        const concentrationDisplay = document.getElementById('concentration-display');
        const concentrationActionBtn = document.getElementById('concentration-action-btn');
        const minimizeBtn = document.getElementById('minimize-btn');
        const programsContainer = document.getElementById('programs-container');
        const glowEffectToggle = document.getElementById('glow-effect-toggle');
        const ledIntensity = document.getElementById('led-intensity');

        // Modales de configuración
        const countUpModal = document.getElementById('config-count-up-modal');
        const countDownModal = document.getElementById('config-count-down-modal');
        const amrapModal = document.getElementById('config-amrap-modal');
        const emomModal = document.getElementById('config-emom-modal');
        const hiitModal = document.getElementById('config-hiit-modal');
        const tabataModal = document.getElementById('config-tabata-modal');

        // Inicializar display con dígitos
        function initDisplay() {
            display.innerHTML = '';
            
            // Crear contenedor para los dígitos
            const digitContainer = document.createElement('div');
            digitContainer.className = 'digit-container flex';
            
            // Crear dígitos y dos puntos en formato HH:MM:SS
            for (let i = 0; i < 8; i++) {
                if (i === 2 || i === 5) {
                    // Crear dos puntos
                    const colon = document.createElement('div');
                    colon.className = 'colon';
                    colon.innerHTML = '<div class="colon-dot"></div><div class="colon-dot"></div>';
                    digitContainer.appendChild(colon);
                } else {
                    // Crear dígito
                    digitContainer.appendChild(createDigit());
                }
            }
            
            display.appendChild(digitContainer);
            
            // Clonar display para modo concentración
            concentrationDisplay.innerHTML = '';
            concentrationDisplay.appendChild(digitContainer.cloneNode(true));
        }
        
        function createDigit() {
            const digit = document.createElement('div');
            digit.className = 'digit relative';
            digit.style.width = '60px';
            digit.style.height = '100px';
            digit.style.margin = '0 3px';
            digit.style.flexShrink = '0';
            
            ['a', 'b', 'c', 'd', 'e', 'f', 'g'].forEach(seg => {
                const segment = document.createElement('div');
                segment.className = `segment segment-${seg}`;
                digit.appendChild(segment);
            });
            
            return digit;
        }
        
        function updateDigit(digit, num) {
            const segments = digit.querySelectorAll('.segment');
            segments.forEach(s => s.classList.remove('on'));
            
            if (num === ' ') return;
            
            digitMap[num].forEach(s => {
                digit.querySelector(`.segment-${s}`).classList.add('on');
            });
        }
        
        function updateDisplay(timeStr) {
            const digits = display.querySelectorAll('.digit');
            const timeChars = timeStr.replace(/:/g, '').split('');
            
            for (let i = 0; i < digits.length; i++) {
                if (timeChars[i] === ' ') {
                    updateDigit(digits[i], ' ');
                } else {
                    updateDigit(digits[i], parseInt(timeChars[i]));
                }
            }
            
            // Actualizar también el display del modo concentración
            if (isFullscreen) {
                const concentrationDigits = concentrationDisplay.querySelectorAll('.digit');
                for (let i = 0; i < concentrationDigits.length; i++) {
                    if (timeChars[i] === ' ') {
                        updateDigit(concentrationDigits[i], ' ');
                    } else {
                        updateDigit(concentrationDigits[i], parseInt(timeChars[i]));
                    }
                }
                
                // Parpadeo de los dos puntos
                const colons = concentrationDisplay.querySelectorAll('.colon-dot');
                const now = new Date();
                const visible = activeProgram === 'clock' ? 
                    (now.getSeconds() % 2 === 0) : 
                    (isTimerRunning && timerValue % 2 === 0);
                
                colons.forEach(dot => dot.style.opacity = visible ? '0.8' : '0.3');
            }
            
            // Parpadeo de los dos puntos
            const colons = display.querySelectorAll('.colon-dot');
            const now = new Date();
            const visible = activeProgram === 'clock' ? 
                (now.getSeconds() % 2 === 0) : 
                (isTimerRunning && timerValue % 2 === 0);
            
            colons.forEach(dot => dot.style.opacity = visible ? '0.8' : '0.3');
        }
        
        function updateClock() {
            if (activeProgram === 'clock') {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                updateDisplay(`${hours}:${minutes}:${seconds}`);
            }
        }
        
        function updateStopwatch() {
            const minutes = Math.floor(stopwatchCentiseconds / 6000);
            const remaining = stopwatchCentiseconds % 6000;
            const seconds = Math.floor(remaining / 100);
            const cents = remaining % 100;
            
            const mins = String(minutes).padStart(2, '0');
            const secs = String(seconds).padStart(2, '0');
            const centsStr = String(cents).padStart(2, '0');
            
            updateDisplay(`  ${mins}:${secs}:${centsStr}`);
        }
        
        function updateTimerDisplay() {
            if (activeProgram === 'clock') return;
            
            let timeStr;
            if (activeProgram === 'stopwatch') {
                updateStopwatch();
                return;
            } else if (countDirection === 'down') {
                const mins = Math.floor(timerValue / 60);
                const secs = timerValue % 60;
                timeStr = `  ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}:00`;
            } else {
                // Contador ascendente
                const mins = Math.floor(timerValue / 60);
                const secs = timerValue % 60;
                timeStr = `  ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}:00`;
            }
            
            updateDisplay(timeStr);
        }
        
        function startTimer() {
            if (isTimerRunning) return;
            
            isTimerRunning = true;
            actionBtn.textContent = 'Pausar';
            concentrationActionBtn.innerHTML = '<i class="fas fa-pause"></i>';
            
            // Deshabilitar otros programas mientras el timer está activo
            document.querySelectorAll('.program-btn').forEach(btn => {
                if (btn.dataset.program !== activeProgram) {
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.6';
                } else {
                    btn.classList.add('running');
                }
            });
            
            if (activeProgram === 'stopwatch') {
                // Usar centésimos para el cronómetro
                stopwatchCentiseconds = 0;
                stopwatchInterval = setInterval(() => {
                    stopwatchCentiseconds++;
                    updateStopwatch();
                }, 10);
            } else {
                timerInterval = setInterval(() => {
                    if (countDirection === 'down') {
                        if (timerValue <= 0) {
                            clearInterval(timerInterval);
                            isTimerRunning = false;
                            actionBtn.textContent = 'Iniciar';
                            concentrationActionBtn.innerHTML = '<i class="fas fa-play"></i>';
                            return;
                        }
                        timerValue--;
                    } else {
                        timerValue++;
                    }
                    
                    updateTimerDisplay();
                }, 1000);
            }
        }
        
        function pauseTimer() {
            if (activeProgram === 'stopwatch') {
                clearInterval(stopwatchInterval);
            } else {
                clearInterval(timerInterval);
            }
            
            isTimerRunning = false;
            actionBtn.textContent = 'Iniciar';
            concentrationActionBtn.innerHTML = '<i class="fas fa-play"></i>';
            
            // Habilitar todos los programas
            document.querySelectorAll('.program-btn').forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                btn.classList.remove('running');
            });
        }
        
        function toggleTimer() {
            if (isTimerRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }
        
        // Convertir mm:ss a segundos
        function timeToSeconds(timeStr) {
            const [mins, secs] = timeStr.split(':').map(Number);
            return (mins * 60) + secs;
        }
        
        // Convertir segundos a mm:ss
        function secondsToTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function setProgram(program) {
            activeProgram = program;
            
            programBtns.forEach(btn => {
                const isActive = btn.dataset.program === program;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('bg-base-200', !isActive);
            });
            
            if (isTimerRunning) {
                pauseTimer();
            }
            
            switch(program) {
                case 'clock':
                    actionBtn.textContent = isConnected ? 'Desconectar dispositivo' : 'Enviar al dispositivo';
                    updateClock();
                    break;
                case 'stopwatch':
                    countDirection = 'up';
                    timerValue = 0;
                    stopwatchCentiseconds = 0;
                    actionBtn.textContent = 'Iniciar';
                    updateStopwatch();
                    break;
                case 'count-up':
                    countDirection = 'up';
                    timerValue = 0;
                    actionBtn.textContent = 'Iniciar';
                    updateTimerDisplay();
                    break;
                case 'count-down':
                    countDirection = 'down';
                    timerValue = programConfig['count-down'].initialTime;
                    actionBtn.textContent = 'Iniciar';
                    updateTimerDisplay();
                    break;
                case 'for-time':
                    countDirection = 'up';
                    timerValue = 0;
                    actionBtn.textContent = 'Iniciar';
                    updateTimerDisplay();
                    break;
                case 'amrap':
                    countDirection = 'down';
                    timerValue = programConfig['amrap'].duration;
                    actionBtn.textContent = 'Iniciar';
                    updateTimerDisplay();
                    break;
                case 'emom':
                    countDirection = 'down';
                    timerValue = programConfig['emom'].totalMinutes * 60;
                    actionBtn.textContent = 'Iniciar';
                    updateTimerDisplay();
                    break;
                case 'hiit':
                    countDirection = programConfig['hiit'].direction;
                    timerValue = programConfig['hiit'].warmup * 60;
                    actionBtn.textContent = 'Iniciar';
                    updateTimerDisplay();
                    break;
                case 'tabata':
                    countDirection = 'down';
                    timerValue = programConfig['tabata'].work;
                    actionBtn.textContent = 'Iniciar';
                    updateTimerDisplay();
                    break;
                default:
                    if (program.startsWith('custom-')) {
                        const customId = program.split('-')[1];
                        const customProgram = customPrograms.find(p => p.id === customId);
                        if (customProgram) {
                            countDirection = customProgram.direction || 'down';
                            timerValue = customProgram.initialTime || 300;
                            actionBtn.textContent = 'Iniciar';
                            updateTimerDisplay();
                        }
                    } else {
                        timerValue = 600;
                        countDirection = 'down';
                        actionBtn.textContent = 'Iniciar';
                        updateTimerDisplay();
                    }
            }
        }
        
        function toggleEditMode() {
            editMode = !editMode;
            document.body.classList.toggle('edit-mode', editMode);
            
            const editIcon = editCorner.querySelector('i');
            if (editMode) {
                editIcon.className = 'fas fa-check';
                customProgramBtn.classList.remove('hidden');
                // Mostrar botones de eliminar en programas personalizados
                document.querySelectorAll('.delete-custom').forEach(btn => {
                    btn.style.display = 'flex';
                });
            } else {
                editIcon.className = 'fas fa-pencil-alt';
                customProgramBtn.classList.add('hidden');
                // Ocultar botones de eliminar en programas personalizados
                document.querySelectorAll('.delete-custom').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }
        
        // Inicializar modales de configuración
        function initProgramModals() {
            // Programas con modal de configuración
            const configurablePrograms = ['count-up', 'count-down', 'amrap', 'emom', 'hiit', 'tabata'];
            
            configurablePrograms.forEach(program => {
                document.querySelector(`[data-program="${program}"]`).addEventListener('click', () => {
                    if (editMode) {
                        // Abrir modal de configuración específico
                        switch(program) {
                            case 'count-up':
                                document.getElementById('count-up-max').value = 
                                    secondsToTime(programConfig['count-up'].maxTime);
                                countUpModal.showModal();
                                break;
                            case 'count-down':
                                document.getElementById('count-down-init').value = 
                                    secondsToTime(programConfig['count-down'].initialTime);
                                countDownModal.showModal();
                                break;
                            case 'amrap':
                                document.getElementById('amrap-duration').value = 
                                    secondsToTime(programConfig['amrap'].duration);
                                amrapModal.showModal();
                                break;
                            case 'emom':
                                document.getElementById('emom-total').value = programConfig['emom'].totalMinutes;
                                document.getElementById('emom-reps').value = programConfig['emom'].reps;
                                emomModal.showModal();
                                break;
                            case 'hiit':
                                document.getElementById('hiit-warmup').value = programConfig['hiit'].warmup;
                                document.getElementById('hiit-work').value = programConfig['hiit'].work;
                                document.getElementById('hiit-rest').value = programConfig['hiit'].rest;
                                document.getElementById('hiit-rounds').value = programConfig['hiit'].rounds;
                                document.getElementById('hiit-cooldown').value = programConfig['hiit'].cooldown;
                                document.querySelector(`#hiit-${programConfig['hiit'].direction}`).checked = true;
                                hiitModal.showModal();
                                break;
                            case 'tabata':
                                document.getElementById('tabata-rounds').value = programConfig['tabata'].rounds;
                                document.getElementById('tabata-work').value = programConfig['tabata'].work;
                                document.getElementById('tabata-rest').value = programConfig['tabata'].rest;
                                tabataModal.showModal();
                                break;
                        }
                    } else {
                        // No estamos en modo edición, seleccionar el programa
                        setProgram(program);
                    }
                });
            });
            
            // Programas sin configuración
            ['clock', 'stopwatch', 'for-time'].forEach(program => {
                document.querySelector(`[data-program="${program}"]`).addEventListener('click', () => {
                    if (editMode) {
                        // En modo edición, no hacemos nada para estos programas
                        return;
                    }
                    setProgram(program);
                });
            });
            
            // Botón de creación de programas personalizados
            customProgramBtn.addEventListener('click', () => {
                if (editMode) {
                    createProgramModal.showModal();
                }
            });
            
            // Aplicar cambios en los modales
            document.getElementById('apply-count-up').addEventListener('click', () => {
                programConfig['count-up'].maxTime = timeToSeconds(
                    document.getElementById('count-up-max').value
                );
                setProgram('count-up');
                countUpModal.close();
            });
            
            document.getElementById('apply-count-down').addEventListener('click', () => {
                programConfig['count-down'].initialTime = timeToSeconds(
                    document.getElementById('count-down-init').value
                );
                setProgram('count-down');
                countDownModal.close();
            });
            
            document.getElementById('apply-amrap').addEventListener('click', () => {
                programConfig['amrap'].duration = timeToSeconds(
                    document.getElementById('amrap-duration').value
                );
                setProgram('amrap');
                amrapModal.close();
            });
            
            document.getElementById('apply-emom').addEventListener('click', () => {
                programConfig['emom'].totalMinutes = parseInt(document.getElementById('emom-total').value);
                programConfig['emom'].reps = parseInt(document.getElementById('emom-reps').value);
                setProgram('emom');
                emomModal.close();
            });
            
            document.getElementById('apply-hiit').addEventListener('click', () => {
                programConfig['hiit'].warmup = parseInt(document.getElementById('hiit-warmup').value);
                programConfig['hiit'].work = parseInt(document.getElementById('hiit-work').value);
                programConfig['hiit'].rest = parseInt(document.getElementById('hiit-rest').value);
                programConfig['hiit'].rounds = parseInt(document.getElementById('hiit-rounds').value);
                programConfig['hiit'].cooldown = parseInt(document.getElementById('hiit-cooldown').value);
                programConfig['hiit'].direction = 
                    document.querySelector('input[name="hiit-direction"]:checked').value;
                setProgram('hiit');
                hiitModal.close();
            });
            
            document.getElementById('apply-tabata').addEventListener('click', () => {
                programConfig['tabata'].rounds = parseInt(document.getElementById('tabata-rounds').value);
                programConfig['tabata'].work = parseInt(document.getElementById('tabata-work').value);
                programConfig['tabata'].rest = parseInt(document.getElementById('tabata-rest').value);
                setProgram('tabata');
                tabataModal.close();
            });
        }
        
        // Crear tarjeta de programa personalizado
        function createCustomProgramCard(program) {
            const card = document.createElement('div');
            card.className = 'program-btn aspect-square bg-base-200 rounded-xl p-2 text-center cursor-pointer transition-all custom-program-card';
            card.dataset.program = `custom-${program.id}`;
            
            const title = document.createElement('div');
            title.className = 'btn-text';
            title.textContent = program.name;
            
            const info = document.createElement('div');
            info.className = 'program-info';
            info.textContent = program.description || 'Programa personalizado';
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-custom';
            deleteBtn.innerHTML = '×';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCustomProgram(program.id);
            });
            
            card.appendChild(title);
            card.appendChild(info);
            card.appendChild(deleteBtn);
            
            // Insertar antes del botón de crear
            programsContainer.insertBefore(card, customProgramBtn);
            
            // Evento para seleccionar el programa
            card.addEventListener('click', () => {
                if (editMode) {
                    // En modo edición, no hacemos nada (solo se puede eliminar)
                    return;
                }
                setProgram(`custom-${program.id}`);
            });
        }
        
        // Eliminar programa personalizado
        function deleteCustomProgram(id) {
            customPrograms = customPrograms.filter(p => p.id !== id);
            document.querySelector(`[data-program="custom-${id}"]`).remove();
            saveCustomPrograms();
        }
        
        // Guardar programas personalizados
        function saveCustomPrograms() {
            localStorage.setItem('customPrograms', JSON.stringify(customPrograms));
        }
        
        // Cargar programas personalizados
        function loadCustomPrograms() {
            const saved = localStorage.getItem('customPrograms');
            if (saved) {
                customPrograms = JSON.parse(saved);
                customPrograms.forEach(createCustomProgramCard);
            }
        }
        
        // Inicializar el modal de creación de programas personalizados
        function initProgramCreationModal() {
            const blockList = document.getElementById('blockList');
            const $ = (id) => document.getElementById(id);
            
            const formatTimeInput = (input) => {
                let v = input.value.replace(/\D/g, "").substring(0, 4);
                if (v.length > 2) v = v.substring(0, 2) + ":" + v.substring(2);
                input.value = v;
            };
            
            const createSubBlock = (data = {}) => {
                const template = document.getElementById('sub-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                if (data.name) title.textContent = data.name;
                if (data.userEditedName) title.dataset.userEdited = "true";
                clone.querySelector('[data-field="time"]').value = data.time || "";
                clone.querySelector('[data-field="warning"]').value =
                    data.warning || "";
                const direction = data.direction || "up";
                clone.querySelector('[data-field="direction"]').value = direction;
                const dirButton = clone.querySelector(
                    `[data-action="set-direction"][data-value="${direction}"]`
                );
                if (dirButton)
                    dirButton.classList.add("bg-primary", "text-primary-content");
                return clone;
            };
            
            const createMainBlock = (data = {}) => {
                const template = document.getElementById('main-block-template');
                const clone = template.content.cloneNode(true);
                const title = clone.querySelector('[data-action="edit-title"]');
                const select = clone.querySelector('[data-field="repeat"]');
                let repeatOptions =
                    '<option value="1">No repetir este bloque</option>';
                for (let i = 2; i <= 99; i++)
                    repeatOptions += `<option value="${i}">Repetir ${i} veces</option>`;
                select.innerHTML = repeatOptions;
                if (data.name) title.textContent = data.name;
                if (data.userEditedName) title.dataset.userEdited = "true";
                select.value = data.repeat || 1;
                const subBlockContainer = clone.querySelector(
                    ".sub-block-list-container"
                );
                if (data.blocks && data.blocks.length > 0) {
                    data.blocks.forEach((subBlockData) =>
                        subBlockContainer.appendChild(createSubBlock(subBlockData))
                    );
                } else {
                    subBlockContainer.appendChild(createSubBlock());
                }
                return clone;
            };
            
            blockList.addEventListener("click", (e) => {
                const button = e.target.closest("[data-action]");
                if (!button) return;
                const action = button.dataset.action;
                const block = button.closest(".main-block, .block-item");
                switch (action) {
                    case "delete-block":
                        block.remove();
                        break;
                    case "toggle-content":
                        const content = block.querySelector(".content");
                        content.classList.toggle("hidden");
                        button.innerHTML = content.classList.contains("hidden")
                            ? "▼"
                            : "▲";
                        break;
                    case "add-sub-block":
                        block
                            .querySelector(".sub-block-list-container")
                            .appendChild(createSubBlock());
                        break;
                    case "edit-title":
                        if (button.querySelector("input")) return;
                        const currentText = button.textContent;
                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = currentText;
                        input.className = "input input-ghost input-xs w-full";
                        input.addEventListener("blur", () => {
                            const newValue = input.value.trim() || currentText;
                            button.textContent = newValue;
                            if (newValue && !newValue.match(/^(Bloque|Sub Bloque) \d+$/i)) {
                                button.dataset.userEdited = "true";
                            } else {
                                delete button.dataset.userEdited;
                            }
                        });
                        input.addEventListener(
                            "keydown",
                            (e) => e.key === "Enter" && e.target.blur()
                        );
                        button.innerHTML = "";
                        button.appendChild(input);
                        input.focus();
                        break;
                    case "set-direction":
                        const parent = button.parentElement;
                        parent
                            .querySelectorAll("button")
                            .forEach((btn) =>
                                btn.classList.remove("bg-primary", "text-primary-content")
                            );
                        button.classList.add("bg-primary", "text-primary-content");
                        parent.querySelector('input[data-field="direction"]').value =
                            button.dataset.value;
                        break;
                }
            });
            
            blockList.addEventListener("focusin", (e) => {
                if (
                    e.target.matches('[data-field="time"], [data-field="warning"]') &&
                    !e.target.value
                ) {
                    e.target.value = "00:00";
                }
            });
            
            blockList.addEventListener("input", (e) => {
                if (e.target.matches('[data-field="time"], [data-field="warning"]')) {
                    formatTimeInput(e.target);
                }
            });
            
            $("addMainBlockBtn").addEventListener("click", () => {
                blockList.appendChild(createMainBlock());
            });
            
            $("cancelCreate").addEventListener("click", () => createProgramModal.close());
        }
        
        // Eventos
        actionBtn.addEventListener('click', () => {
            if (activeProgram === 'clock') {
                if (isConnected) {
                    isConnected = false;
                    actionBtn.textContent = 'Enviar al dispositivo';
                } else {
                    isConnected = true;
                    actionBtn.textContent = 'Desconectar dispositivo';
                }
            } else {
                toggleTimer();
            }
        });
        
        editCorner.addEventListener('click', toggleEditMode);
        globalConfigBtn.addEventListener('click', () => configModal.showModal());
        themeSwitcher.addEventListener('change', (e) => {
            document.documentElement.setAttribute('data-theme', e.target.value);
            if (e.target.value === 'light' || e.target.value === 'corporate') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        });
        
        // Configuración del efecto de retroiluminación
        glowEffectToggle.addEventListener('change', (e) => {
            glowEffectEnabled = e.target.checked;
            document.body.classList.toggle('glow-effect', glowEffectEnabled);
        });
        
        // Configuración de intensidad LED
        ledIntensity.addEventListener('input', (e) => {
            const intensity = e.target.value;
            document.documentElement.style.setProperty('--glow-intensity', `${intensity}px`);
        });
        
        // Guardar configuración
        document.getElementById('save-config').addEventListener('click', () => {
            localStorage.setItem('glowEffect', glowEffectToggle.checked);
            localStorage.setItem('ledIntensity', ledIntensity.value);
            configModal.close();
        });
        
        // Modo concentración
        fullscreenBtn.addEventListener('click', () => {
            if (activeProgram === 'clock') {
                isFullscreen = true;
                concentrationMode.classList.remove('hidden');
            }
        });
        
        concentrationActionBtn.addEventListener('click', toggleTimer);
        minimizeBtn.addEventListener('click', () => {
            isFullscreen = false;
            concentrationMode.classList.add('hidden');
        });
        
        // Crear programa personalizado
        document.getElementById('programForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const programName = document.getElementById('program-name').value;
            const programId = 'custom-' + Date.now();
            
            const newProgram = {
                id: programId,
                name: programName,
                description: document.getElementById('program-description').value,
                countdown: document.getElementById('countdown').value,
                initialTime: 300, // Valor por defecto
                direction: 'down'  // Valor por defecto
            };
            
            customPrograms.push(newProgram);
            createCustomProgramCard(newProgram);
            saveCustomPrograms();
            
            createProgramModal.close();
            document.getElementById('programForm').reset();
        });
        
        // Cancelar creación de programa
        document.getElementById('cancelCreate').addEventListener('click', () => {
            createProgramModal.close();
        });
        
        // Inicialización
        function initApp() {
            initDisplay();
            initProgramModals();
            initProgramCreationModal();
            loadCustomPrograms();
            setProgram('clock');
            setInterval(updateClock, 1000);
            
            // Cargar configuración guardada
            const savedGlow = localStorage.getItem('glowEffect');
            if (savedGlow !== null) {
                glowEffectEnabled = savedGlow === 'true';
                glowEffectToggle.checked = glowEffectEnabled;
                document.body.classList.toggle('glow-effect', glowEffectEnabled);
            }
            
            const savedIntensity = localStorage.getItem('ledIntensity');
            if (savedIntensity !== null) {
                ledIntensity.value = savedIntensity;
                document.documentElement.style.setProperty('--glow-intensity', `${savedIntensity}px`);
            }
        }
        
        // Iniciar la aplicación
        initApp();
    </script>
</body>
</html>
